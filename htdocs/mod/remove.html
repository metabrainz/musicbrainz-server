<%perl>
	# -----------------------------------------------------------------------------
	#                               Musicbrainz.org
	#                        Copyright (c) 2001 Robert Kaye
	# -----------------------------------------------------------------------------
	#  This software is provided "as is", without warranty of any kind, express or
	#  implied, including  but not limited  to the warranties of  merchantability,
	#  fitness for a particular purpose and noninfringement. In no event shall the
	#  authors or  copyright  holders be  liable for any claim,  damages or  other
	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
	#  from,  out of  or in  connection with  the software or  the  use  or  other
	#  dealings in the software.
	#
	#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
	#  Permits anyone the right to use and modify the software without limitations
	#  as long as proper  credits are given  and the original  and modified source
	#  code are included. Requires  that the final product, software derivate from
	#  the original  source or any  software  utilizing a GPL  component, such  as
	#  this, is also licensed under the GPL license.
	# -----------------------------------------------------------------------------
	#
	# Summary:
	# -----------------------------------------------------------------------------
	# This page allows an Editor to remove/cancel a pending edit
	#
	# $Id$
	#
</%perl>
<%args>

	$modid => 0
	$editid => undef

	$notetext => ""
	$submitvalue => ""
	$url => "/mod/search/pre/moderator.html"
        $inline => 0

</%args>
<%perl>

	$editid ||= $modid;

	# sanitize modid argument
	if ($editid < 1)
	{
		$m->comp("/comp/badargs");
		return undef;
	}

	# Instantiate MusicBrainz object
	my $mb = $m->comp("/comp/dblogin");

	# load moderation from given $editid argument
	my $edit = Moderation->new($mb->{DBH});
	$edit = $edit->CreateFromId($editid);
	if (not defined $edit)
	{
		$m->comp("/comp/error", "The edit #$editid was not found.");
		return undef;
	}
	if ($edit->GetStatus != &ModDefs::STATUS_OPEN)
	{
		$m->comp("/comp/error", "The edit #$editid is not in a status that allows removal.");
		return undef;
	}

	$edit->PreDisplay;

	# form was submitted, see which button it was.
	if ($submitvalue ne "")
	{
		if ($submitvalue =~ m/Cancel edit/)
		{
		    my $sql = Sql->new($mb->{DBH});
			eval
			{
				$sql->Begin;
				$edit->RemoveModeration($session{uid});

				# Insert a note
				$edit->InsertNote($session{"uid"}, $notetext)
					if ($notetext);

				$sql->Commit;
			};
			if ($@)
			{
				my $err = $@;
				$sql->Rollback;
				$m->out("<b>A database error occurred.</b><pre>($err)</pre>");
				$m->comp("/comp/footer");
				return undef;
		    }
		}

		# forward to $url
		$r->method("GET");
		$r->headers_in->unset("Content-length");
		$r->content_type("text/html; charset=UTF-8");
		$r->header_out(Location => $url);
		$r->status(302);
		return undef;
	}

</%perl>

% if ($inline) {
    <& /comp/header_inline, title => "Confirm edit removal", nosmallfonts => 1, noentityicons => 0 &>
% } else {
    <& /comp/sidebar-notitle, pagetitle => "Confirm edit removal" &>
% }

    	<& /comp/tablebegin, title => "Confirm edit removal" &>

	<form method="post" action="/mod/remove.html" id="ConfirmForm">

		<table class="formstyle">
			<tr>
				<td colspan="2" class="instructions">
					<ul>
						<li>Do you want to cancel this edit?</li>
					</ul>
				</td>
			</tr>
			<tr class="top">
				<td class="label">
					<label>Edit type:</label>
				</td>
				<td>
					<%perl>
						$edit->ShowModType($m);
					</%perl></td>
			</tr>
			<tr class="top">
				<td class="label">
					<label>Previous value:</label>
				</td>
				<td>
				<%perl>
					$edit->ShowPreviousValue($m);
				</%perl></td>
			</tr>
			<tr class="top">
				<td class="label">
					<label>New value:</label>
				</td>
				<td>
				<%perl>
					$edit->ShowNewValue($m);
				</%perl></td>
			</tr>
			<tr>
				<td>&nbsp;</td>
				<td>
					<& /comp/notetext,
						required => 0,
						buttons => [["Cancel edit &raquo;", "btnYes"], ["No, keep it", "btnCancel"]],
						showprivscheckbox => 0,
						showeditnotetext => 0
					&>
				
					<& /comp/form/focusfield, "btnCancel" &>
					<& /comp/args-to-hidden-fields.inc, %ARGS &>
				</td>
			</tr>
		</table>

	</form>

	<& /comp/tableend &>

	<& /comp/js/diffcollapse &>

% if ($inline) {
    <& /comp/footer_inline &>
% } else {
    <& /comp/footer &>
% }

%# vi: set ts=4 sw=4 ft=mason :
