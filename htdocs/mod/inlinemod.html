<%perl>
	# -----------------------------------------------------------------------------
	#                               Musicbrainz.org
	#                        Copyright (c) 2001 Robert Kaye
	# -----------------------------------------------------------------------------
	#  This software is provided "as is", without warranty of any kind, express or
	#  implied, including  but not limited  to the warranties of  merchantability,
	#  fitness for a particular purpose and noninfringement. In no event shall the
	#  authors or  copyright  holders be  liable for any claim,  damages or  other
	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
	#  from,  out of  or in  connection with  the software or  the  use  or  other
	#  dealings in the software.
	#
	#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
	#  Permits anyone the right to use and modify the software without limitations
	#  as long as proper  credits are given  and the original  and modified source
	#  code are included. Requires  that the final product, software derivate from
	#  the original  source or any  software  utilizing a GPL  component, such  as
	#  this, is also licensed under the GPL license.
	# -----------------------------------------------------------------------------
	#
	# Summary:
	# -----------------------------------------------------------------------------
	# Renders the content of the inline voting iframe.
	#
	# $Id$
	#
</%perl>
<%args>

	$artistid

</%args>

<%def .GetRelatedModeration>
<%perl>

    my ($modobj, $artistid, $uid) = @_;
	my $result;

	my $try_search = sub {
		my ($query, $voter_id) = $m->comp("/mod/search/setquery.inc", dbh => $modobj->GetDBH, @_);
		my ($status, $list, $num) = $modobj->GetModerationList($query, $voter_id, 0, 1);

		return $list->[0]
			if $status == Moderation::SEARCHRESULT_SUCCESS
			and $num > 0;

		return "timeout"
			if $status == Moderation::SEARCHRESULT_TIMEOUT;

		();
	};

    # First, look for moderations that are open by the given artist
	$result = &$try_search(
        artist_type     => 3, # only this artist ...
        artist_id       => $artistid,
        moderator_type  => 5,
        voter_id        => $uid,
        vote_cast       => [ &ModDefs::VOTE_NOTVOTED ],
        mod_status      => [ &ModDefs::STATUS_OPEN ],
        orderby         => "desc"
	) and return ($result, "Please vote on this edit by the same artist:")
		unless $artistid == &ModDefs::VARTIST_ID;

    # Now look for moderations from subscribed artists
	$result = &$try_search(
        mod_status      => [ &ModDefs::STATUS_OPEN ],
        vote_cast       => [ &ModDefs::VOTE_NOTVOTED ],
        voter_type      => 0,
        moderator_type  => 5,
        artist_type     => 4, # subbed artists
        orderby         => "asc"
	) and return ($result, "Please vote on this edit by one of your subscribed artists:");

    # Now look for moderations from related artists
	$result = &$try_search(
        artist_type     => 5, # only this artist ...
        artist_id       => $artistid,
        moderator_type  => 5,
        voter_id        => $uid,
        vote_cast       => [ &ModDefs::VOTE_NOTVOTED ],
        mod_status      => [ &ModDefs::STATUS_OPEN ],
        orderby         => "desc"
	) and return ($result, "Please vote on this edit by a related artist:");

    # Return now if the user hasn't selected to show random inline mods
    return if !$session{PREF_show_inline_mods_random};

    # Now look for any open edit
	$result = &$try_search(
			moderator_type  => 5,
			voter_id        => $uid,
			vote_cast       => [ &ModDefs::VOTE_NOTVOTED ],
			mod_status      => [ &ModDefs::STATUS_OPEN ],
			orderby         => "desc"
    ) and return ($result, "Please vote on this random edit:");

	return;

</%perl>
</%def>
<%perl>

	# instantiate musicbrainz object.
	my $mb = $m->comp("/comp/dblogin");
	my $edit = Moderation->new($mb->{DBH});

	my ($reledit, $pleasevote) = $m->comp(".GetRelatedModeration", $edit, $artistid, $session{uid});

	my $noentityicons = UserPreference::get("css_noentityicons");
	my $nosmallfonts = UserPreference::get("css_nosmallfonts");

</%perl>

	<& /comp/header_inline,
		title => "Inline edit",
		head => qq!<base target="_parent">!,
		nosmallfonts => $nosmallfonts,
		noentityicons => $noentityicons &>

	<script type="text/javascript" src="/scripts/jsvoting.js"></script>

	<div style="margin: 5px 0px; padding: 5px; border: 1px dotted #000">

%	if ($reledit eq "timeout")
%	{
		Related edits search timed out - sorry...
%	}
%	elsif (not $reledit)
%	{
		No open edits found.
%		if (!$session{PREF_show_inline_mods_random})
%		{

		You have chosen not to display random inline edits here. You can
		change this setting in your <a href="/user/preferences.html">user preferences</a>.

%		}
%	}
%	else
%	{
		<% $pleasevote %>
%	}

	</div>

%	if ($reledit)
%	{
%		my @notes = do {
%			my $notes = MusicBrainz::Server::ModerationNote->new($mb->{DBH});
%			$notes->newFromModerationIds($reledit->GetId);
%		};

	<form method="post" action="/bare/vote.html" target="_self">

		<table class="editlist">

%		my $show_button = 1;

		<& /comp/showmod,
			edit => $reledit,
			notes => \@notes,
			voter => $session{uid},
			voteflag => \$show_button,
			inline => 1 &>

		</table>
		<script type="text/javascript" src="/scripts/jsdiff.js"></script>
		<input type="hidden" name="url" value="<% $r->uri() . "?" . $r->args() %>" />
	</form>

%	}

<& /comp/footer_inline &>

%# vi: set ts=4 sw=4 ft=mason :
