<%perl>
	# -----------------------------------------------------------------------------
	#                               Musicbrainz.org
	#                        Copyright (c) 2001 Robert Kaye
	# -----------------------------------------------------------------------------
	#  This software is provided "as is", without warranty of any kind, express or
	#  implied, including  but not limited  to the warranties of  merchantability,
	#  fitness for a particular purpose and noninfringement. In no event shall the
	#  authors or  copyright  holders be  liable for any claim,  damages or  other
	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
	#  from,  out of  or in  connection with  the software or  the  use  or  other
	#  dealings in the software.
	#
	#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
	#  Permits anyone the right to use and modify the software without limitations
	#  as long as proper  credits are given  and the original  and modified source
	#  code are included. Requires  that the final product, software derivate from
	#  the original  source or any  software  utilizing a GPL  component, such  as
	#  this, is also licensed under the GPL license.
	# -----------------------------------------------------------------------------
	#
	# Summary:
	# -----------------------------------------------------------------------------
	# This page provides the new (lucene based) search functionality.
	#
	# $Id$
	#
</%perl>
<%args>

	$handlearguments => 0
    $offset => 0
    $page => undef

</%args>
<%perl>


	# catch queries which have been created before the session handling and trigger
	# storing of these values.
	if ($ARGS{"query"} and
		$ARGS{"type"} and
		not $ARGS{"handlearguments"} and
		not $ARGS{"submitvalue"})
	{
		($handlearguments, $ARGS{"handlearguments"}) = (1,1);
	}

	$m->comp("/search/handle-searchsession.inc", %ARGS)
		if ($handlearguments);

	$offset = ($page - 1) * $session{"as_limit"}
		if (defined $page);

	if ($session{"as_query"} ne "" && $session{"as_type"} ne "")
	{
		use URI::Escape qw( uri_escape );

        $session{"as_query"} = 'chkchkchk' if ($session{"as_query"} eq '!!!' && $session{"as_type"} eq 'artist');

        my $query = $session{"as_query"};
        if (!exists $session{"as_adv"} or !$session{"as_adv"})
        {
            $query =~ tr/A-Z/a-z/;
            $query = MusicBrainz::Server::LuceneSearch::EscapeQuery($query);
            if ($session{"as_type"} eq 'artist')
            {
                $query = "artist:($query)(sortname:($query) alias:($query) !artist:($query))";
            }
            elsif ($session{"as_type"} eq 'release')
            {
                $query = "release:($query)(barcode:($query) !release:($query))";
            }
            elsif ($session{"as_type"} eq 'label')
            {
                $query = "label:($query)(code:($query) !label:($query))";
            }
        }

		my $docurl = 	'http://'
					  . &DBDefs::LUCENE_SERVER
					  . "/ws/1/"
					  . $session{"as_type"}
					  . "/?query="
					  . uri_escape($query)
					  . "&type="
					  . $session{"as_type"};
		$docurl 	  .= "&offset=$offset";
		$docurl 	  .= "&max="
					  . $session{"as_limit"} if ($session{"as_limit"} >= 0);
		$docurl 	  .= "&tport="
					  . $session{"tport"} if ($session{"tport"} > 0);
		$docurl 	  .= "&dur="
					  . $session{"as_dur"} if ($session{"as_dur"} > 0);
        $docurl       .= '&rel=1' if ($session{uid});

		require LWP::UserAgent;
		my $ua = LWP::UserAgent->new;
		$ua->env_proxy;
		$ua->timeout(5);
		my $response = $ua->get($docurl);
		if (!$response->is_success)
		{
			if ($response->code == 404)
			{
	            $m->comp("/comp/sidebar-notitle", pagetitle => "Indexed Search");
                </%perl>
				<& /comp/tablebegin, title => "No ".$session{"as_type"}."s found matching your query" &>
					<ul>
						<li>
							Your query <code><strong><% $session{"as_query"} |h %></strong></code> did not match
							any <% $session{"as_type"} %>s. Please check if you used the correct spelling, sometimes
							fewer or different words might help.</li>

						<li>For help on writing effective text
							search queries, please read the <& /comp/linkdoc, "TextSearchSyntax",
							"text search syntax" &> document.</li>

%						if ($session{"as_type"} eq "label") {
						<li>Please consider <a href="/edit/label/add.html?initial_name=<% uri_escape($session{"as_query"}) %>">adding a new label</a>.</li>
%						} else {
						<li>Please consider <a href="/freedb/freedb.html?search=<% uri_escape($session{"as_query"}) %>"
							>importing</a> the artist/release/track(s) you are looking for from freedb.</li>
%						}
					</ul>
				<& /comp/tableend &>

%			}
%			elsif ($response->code == 400)
%			{
	            <& /comp/sidebar-notitle, pagetitle => "Indexed Search" &>
				<& /comp/tablebegin, title => "Not enough information given" &>
					<ul>
						<li>
							Your query <code><strong><% $session{"as_query"} |h %></strong></code> does not
							contain enough information to carry out a search. If you are
							attempting to find an artist that contains nothing but punctuation
							characters (e.g. !!!) then you need to use the <a href="/browseartists.html?index=_"
							>Browse Artists</a> page to find the artist you are looking for, since
							this search ignores punctuation characters.</li>
						<li>For help on writing effective text
							search queries, please read the <& /comp/linkdoc, "TextSearchSyntax",
							"text search syntax" &> document.</li>
					</ul>
				<& /comp/tableend &>

%			}
%			elsif ($response->code == 500)
%			{
	            <& /comp/sidebar-notitle, pagetitle => "Indexed Search" &>
				<& /comp/tablebegin, title => "Internal Error" &>
                    <p>
					The search server could not fulfill your request due to an
					internal error. Please try again later.
                    </p>
                    <p>
                    Error: <% $response->content %>
                    </p>
				<& /comp/tableend &>
%               MusicBrainz::Server::LogFile::lprint("textsearch", "Search server returned 500: " . $response->content);
%			}
%			elsif ($response->code == 403)
%			{
	            <& /comp/sidebar-notitle, pagetitle => "Indexed Search" &>
				<& /comp/tablebegin, title => "Error" &>
       				<p>
                    <b>Error:</b> Your search query was deemed invalid by our ruthless search server.
                    </p>
                    <p>
					For help on writing valid text search queries, please read the 
                    <& /comp/linkdoc, "TextSearchSyntax", "text search syntax" &> document.
                    </p>
                    <p>
                    The (probably) useless error message provided by the search server was:
                    </p>
                    <blockquote>
                    <% $response->content %>
                    </blockquote>
				<& /comp/tableend &>

%	        }
%			else
%			{
	            <& /comp/sidebar-notitle, pagetitle => "Indexed Search" &>
				<& /comp/tablebegin, title => "Error" &>
       				<p>
                    Could not execute search:<br/><% $response->content %>
                    </p>
				<& /comp/tableend &>
%               MusicBrainz::Server::LogFile::lprint("textsearch", "Search server returned " . $response->code . ": " . $response->content);
%	        }
%	    }
%		else
%		{
%#              TODO: Move this to a perl module
                <%perl>
 			    my $matchname = $session{as_type} eq 'freedb' ? "FreeDB CDs" : "${session{as_type}}s";
                my $temp; # must be declared outside the for
                my $content = $response->content;
                my $total_hits = 0;
                for(;;) 
                {
                    if ($content =~ /%WIKIBEGIN%(.*?)%WIKIEND%/s) 
                    {
                         $temp = Text::WikiFormat::format($1, {}, { prefix => "http://wiki.musicbrainz.org/", extended => 1, absolute_links => 1, implicit_links => 0 });
                         $content =~ s/%WIKIBEGIN%(.*?)%WIKIEND%/$temp/s;
                    } 
                    else 
                    {    
                         last; 
                    }
                }

                my $redirect = "";
                if ($content =~ /<!--\s+(.*?)\s+-->/s)
                {
                    my $comment = $1;

                    foreach my $com (split(/\n/, $comment))
                    {
                        my ($key, $value) = split(/=/, $com, 2);

                        $total_hits = $value if ($key eq 'hits');
                        $redirect = $value if ($key eq 'redirect');
                    }
                }
                my $type = $session{"as_type"};
                if ($total_hits == 1 && ($type eq 'artist' || $type eq 'release' || $type eq 'track'))
                {
                    $m->comp("/comp/redirect", "/$type/$redirect.html");
                    return;
                }
                </%perl>
	            <& /comp/sidebar-notitle, pagetitle => "Indexed Search" &>
				<& /comp/layout/editformbegin, title => "The following $matchname matched your query", mp => 0, show_coc => 0 &>
                    <& /comp/browse/pageselector, numitems => $total_hits,
                                           offset=>$offset, 
                                           numlinks => 4,
                                           pagesize=> ($session{"as_limit"} or 25),
                                           url => "/search/textsearch.html",
                                           args =>{ query => $session{"as_query"},
													adv => $session{"as_adv"},
													limit => $session{"as_limit"},
                                                    type => $type,
                                                    handlearguments => $handlearguments
                                                  } &>

					<% $content |n %>

                    <& /comp/browse/pageselector, numitems => $total_hits,
                                           offset=>$offset, 
                                           numlinks => 4,
                                           pagesize=> ($session{"as_limit"} or 25),
                                           url => "/search/textsearch.html",
                                           args =>{ query => $session{"as_query"},
													adv => $session{"as_adv"},
													limit => $session{"as_limit"},
                                                    type => $type,
                                                    handlearguments => $handlearguments
                                                  } &>

				<& /comp/layout/editformend &>

%    	}

		<div style="margin-top: 20px"></div>

%	}
%	else
%	{
        <& /comp/sidebar-notitle, pagetitle => "Indexed Search" &>
%		if ($session{"as_query"} ne "" || $session{"as_type"} ne "")
%		{
            <& /comp/tablebegin, title=>"Results" &>
                <table style="margin: 0.3em">
                    <tr>
                        <td>
                            Please enter a search phrase including letters and/or numbers.
                        </td>
                    </tr>
                </table>
            <& /comp/tableend &>

            <div style="margin-top: 20px"></div>
%		}
%	}

	<& /comp/tablebegin, title=>"Search (Indexed Search)" &>
		<table>
			<tr valign="top">
				<td style="width: 50%">
					<& /comp/lucenesearch, handlearguments => 0 &>
				</td>
				<td style="padding: 0.3em 4em">
					<b>Please Note:</b>
					<ul>
						<li>
							Search indexes are currently updated once a day at 1800 GMT (10am PST).
							If you require up to the minute correct search, please use the
							<a href="/search/oldsearch.html">old search</a>.</li>

% 				if ($session{"as_type"} eq "artist")
%				{

						<li>
							Another possible starting point is to use the <a href="/browseartists.html"
							>Browse Artists</a> page to find the artist you are looking for.</li>
						<li>Alternatively, <a href="/edit/artist/add.html?initial_name=<% uri_escape($session{"as_query"}) %>">
							add a new artist</a>.</li>

% 				}
% 				elsif ($session{"as_type"} eq "release")
%				{

						<li>
							Another possible starting point is to use the <a href="/browsevarious.html"
							>Browse Releases</a> page to find the release you are looking for.</li>
						<li>
							Alternatively, <a href="/edit/album/add.html?artistid=0">add a new release</a>.</li>

% 				}
% 				elsif ($session{"as_type"} eq "label")
%				{

						<li>
							Another possible starting point is to use the <a href="/browselabels.html"
							>Browse Labels</a> page to find the label you are looking for.</li>
						<li>
							Alternatively, <a href="/edit/label/add.html?initial_name=<% uri_escape($session{"as_query"}) %>">add a new label</a>.</li>

% 				}

				</ul>

				</td>
			</tr>
		</table>
	<& /comp/tableend &>

<& /comp/footer &>

%# vi: set ts=4 sw=4 ft=mason :
