<%perl>
	# -----------------------------------------------------------------------------
	#                               Musicbrainz.org
	#                        Copyright (c) 2001 Robert Kaye
	# -----------------------------------------------------------------------------
	#  This software is provided "as is", without warranty of any kind, express or
	#  implied, including  but not limited  to the warranties of  merchantability,
	#  fitness for a particular purpose and noninfringement. In no event shall the
	#  authors or  copyright  holders be  liable for any claim,  damages or  other
	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
	#  from,  out of  or in  connection with  the software or  the  use  or  other
	#  dealings in the software.
	#
	#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
	#  Permits anyone the right to use and modify the software without limitations
	#  as long as proper  credits are given  and the original  and modified source
	#  code are included. Requires  that the final product, software derivate from
	#  the original  source or any  software  utilizing a GPL  component, such  as
	#  this, is also licensed under the GPL license.
	# -----------------------------------------------------------------------------
	#
	# Summary:
	# -----------------------------------------------------------------------------
	# This page handles three types of requests:
	#
	# * /showalbum.html?discid=.... (CDIndexId or FreeDBId only, no TOC)
	# * from /search.html, search by disc id (either CDIndexId or FreeDBId, no TOC)
	# * direct request from libmusicbrainz (see GetWebSubmitURL) (has TOC; disc id ignored)
	#
	# $Id$
	#
</%perl>
<%args>

	$id => undef
	$discid => undef
	$freedbid => undef

	$toc => undef
	$tport => $session{'tport'}

	# tracks can be passed too, but we'll ignore it
	$tracks => ""

</%args>
<%perl>

	# check session
	UserStuff::EnsureSessionOpen(), $session{tport} = $tport
		  if $tport;

	# handle overloaded id parameter
	use MusicBrainz::Server::CDTOC ':hashlength';
	$freedbid = $id
		if (not defined $discid and length($id) == FREEDB_ID_LENGTH);
	$discid = $id
		if (not defined $freedbid and length($id) == CDINDEX_ID_LENGTH);

	# verify the TOC parameter
	my %info;
	if (defined $toc)
	{
		%info = MusicBrainz::Server::CDTOC->ParseTOC($toc);
		keys(%info)
			? ($discid = $info{discid}) # ensure discid matches toc
			: ($toc = undef); # discard invalid toc
	}

	# if neither discid nor toc are provided, abort.
	if (not defined $freedbid and
		not defined $discid and
		not defined $toc)
	{
		return $m->comp("/comp/layout/badarguments",
			text => qq!You need to pass a Disc ID <strong>discid</strong>
					  and / or the complete CD TOC <strong>toc</strong>!);
	}

	# Instantate MusicBrainz object
	my $mb = $m->comp("/comp/dblogin");

	# Here we split into two paths, depending on whether we or not we were passed
	# the TOC.
	if (not defined $toc)
	{
		# If we have no TOC then we cannot add the release if it's missing.  So just
		# look for the release (based on CDIndex ID or FreeDB ID) and show whatever we
		# find. etrieve the releases matching the given ID
		my $alcdtoc = MusicBrainz::Server::ReleaseCDTOC->new($mb->{DBH});
		my $releaseids = (
			$discid
				? $alcdtoc->GetReleaseIDsFromDiscID($discid)
				: $freedbid
					? $alcdtoc->GetReleaseIDsFromFreeDBID($freedbid)
					: []);

		# No matches, and we cant add the release since we have no toc,
		# we can't add a new release. Just show the message.
		if (not @$releaseids)
		{

</%perl>

		<& /comp/sidebar-notitle, pagetitle => "Lookup returned no match." &>
		<& /comp/tablebegin, title => "Lookup returned no match." &>

%		my $text = "";
%		if ($discid)
%		{
			No release found with the given <& /comp/linkdoc, "DiscID", "Disc ID" &>
			<code><% $discid %></code>. Please try again.

%		}
%		else
%		{

			No release found with the given <strong>FreeDB ID</strong>
			<code><% $freedbid %></code>. Please try again.

%		}


<%perl>

		}

		# Exactly one match redirect to it
		elsif (@$releaseids == 1)
		{
			$m->comp("/comp/redirect", "/show/release/?releaseid=".$releaseids->[0]);
		}

		# Multiple matching releases - show them all
		else
		{

</%perl>
			<& /comp/sidebar-notitle, pagetitle => "Multiple releases found." &>
			<& /comp/tablebegin, title => "Multiple releases found." &>


			The following releases <% @$releaseids == 2 ? "both" : "all" %> have
			the

%			if ($discid)
%			{

			<& /comp/linkdoc, "DiscID", "Disc ID" &>: <% $discid %>

%			}
%			else
%			{

			<strong>FreeDB ID</strong>: <% $freedbid %>

%			}

			<& .ShowMultipleAlbums, dbh => $mb->{DBH}, releaseids => $releaseids &>

<%perl>

		}
	}
	else
	{
		# If on the other hand we have a TOC then we can add the release if it's
		# missing. First let's look for releases using this TOC (which is in any case
		# more accurate than simply looking up based on CDIndex ID).

		require MusicBrainz::Server::CDTOC;
		my $releaseids;
		{
			my $cdtoc = MusicBrainz::Server::CDTOC->newFromTOC($mb->{DBH}, $toc);
			$releaseids = [], last
				if not $cdtoc;

			if ($cdtoc)
			{
				my $relcdtocs = $cdtoc->GetReleaseCDTOCs;
				$releaseids = [ map { $_->GetReleaseId } @$relcdtocs ];
			}
		}

		# No releases.  Perhaps the user wants to enter one?
		if (not @$releaseids)
		{

</%perl>

		<& /comp/sidebar-notitle, pagetitle => "Lookup returned no matches" &>
		<& /comp/tablebegin, title => "Lookup returned no matches" &>

			MusicBrainz doesn't currently have any releases which have this TOC: <br />

			<div style="border: 1px dotted #999; margin-top: 10px; margin-bottom: 10px; padding: 5px;">
				<% $toc %>
			</div>

		<& .ShowSubmitForm, \%info &>

<%perl>

		}
		else
		{
			my $singlematch = (@$releaseids == 1);
			my $title = $singlematch
				? "CD TOC matched exactly one release"
				: "CD TOC matched multiple releases";

</%perl>

		<& /comp/sidebar-notitle, pagetitle => $title &>
		<& /comp/tablebegin , title => $title &>

			<table class="formstyle">
				<tr>
					<td class="instructions">
						<ul>

%			if ($singlematch)
%			{

							<li>
								One release found which matches your <strong>CD TOC</strong>:
								<strong><% $toc %></strong>.</li>
							<li>
								If this is not the release you were looking for, please use
								the <strong>Attach TOC to Release / Add new Release </strong>
								form below to enter your copy into the database.
							</li>

%			}
%			else
%			{

							<li>
								There are multiple releases in the database which match your
								<strong>CD TOC</strong>: <strong><% $toc %></strong>.</li>
							<li>
								If the release you are looking up is <% (@$releaseids == 2
								? "neither" : "none") %> of them, please use the <strong>
								Attach TOC to Release / Add new Telease </strong>
								form below to enter your copy into the database.
							</li>

%			}

						</ul>
					</td>
				</tr>
			</table>


			<& .ShowMultipleAlbums, dbh => $mb->{DBH}, releaseids => $releaseids &>

			<& .ShowSubmitForm, \%info &>

%		}
%	}

	<& /comp/js/diffcollapse &>

	<& /comp/tableend &>
<& /comp/footer &>






<%def .ShowSubmitForm>
% 	my $info = shift;
% 	my $url = "/bare/cdlookup.html?toc=" . uri_escape($info->{'toc'});

	<& /comp/tableend &>

	<& /comp/tablebegin, title => "Attach TOC to release / Add new release " &>

% 	if (&DBDefs::REPLICATION_TYPE == RT_SLAVE)
%	{

		This is a mirror server. You need to <a href="http://musicbrainz.org<% $url %>">
		go to the main server</a> to enter a new release.

% 	}
%	elsif ($session{uid})
%	{

		<table class="formstyle">
			<tr>
				<td class="instructions">
					<ul>
						<li>
							You can either search for releases by selecting an artist first,
							or by searching for releases directly. Please note that you have
							to use the release search if the release you are looking for
							is a <& /comp/linkdoc, "VariousArtistsRelease", "Various Artists Release" &>.
						</li>
						<li>
							All data submitted to MusicBrainz will be placed into
							the public domain and released using a <a href="http://creativecommons.org">
							Creative Commons</a> license. For more information see our
							<& /comp/linkdoc, "MusicBrainzLicense", "licences page" &>.
						</li>
					</ul>
				</td>
			</tr>
		</table>

		<table class="formstyle">
			<tr>
				<td>&nbsp;</td>
				<td>
					Enter the name of the <strong>artist</strong> and
					click on the button <strong>Search&nbsp;&raquo;</strong>:
				</td>
			</tr>
			<tr>
				<td class="label">Search for artist:</td>
				<td>
					<form method="post" action="/cdi/searchartist.html">
						<div>
							<input type="text" name="search" size="30" />
							<input type="submit" value="Search &raquo;" />
							<input type="hidden" name="discid" value="<% $info->{'discid'} %>" />
							<input type="hidden" name="toc" value="<% $info->{'toc'} %>" />
							<input type="hidden" name="tracks" value="<% $info->{'tracks'} %>" />
						</div>
					</form>
				</td>
			</tr>

			<tr class="spaced">
				<td>&nbsp;</td>
				<td>
					Enter the name of the <strong>release</strong> and
					click on the button <strong>Search&nbsp;&raquo;</strong>:
				</td>
			</tr>
			<tr>
				<td class="label">Search for release:</td>
				<td>
					<form method="post" action="/cdi/searchrelease.html">
						<div>
							<input type="text" name="search" size="30" />
							<input type="submit" value="Search &raquo;" />
							<input type="hidden" name="discid" value="<% $info->{'discid'} %>" />
							<input type="hidden" name="toc" value="<% $info->{'toc'} %>" />
							<input type="hidden" name="tracks" value="<% $info->{'tracks'} %>" />
						</div>
					</form>
				</td>
			</tr>
		</table>

% 	}
%	else
%	{

		You need to login first before you can enter a new release.

		<& /comp/loginbox, url=> $url &>

% 	}

</%def>



<%def .ShowMultipleAlbums>
<%args>

	$dbh
	$releaseids

</%args>
<%perl>

	# Retrieve each release, and the artist for each one
	my %artists;

	for my $releaseid (@$releaseids)
	{
		my $release = MusicBrainz::Server::Release->new($dbh);
		$release->SetId($releaseid);
		$release->LoadFromId or next;

		my $artist = $artists{ $release->GetArtist } ||= do {
			my $artist = MusicBrainz::Server::Artist->new($dbh);
			$artist->SetId($release->GetArtist);
			$artist->LoadFromId ? $artist : undef;
		};
		$artist or next;
		push @{ $artist->{_releases} }, $release;
	}

	my @artists = values %artists
		or return;

	$_->{_sort} = MusicBrainz::Server::Validation::NormaliseSortText($_->GetSortName)
		for @artists;


	$m->out(qq!<table width="600">!);
	$m->out(qq!<tr><td>!);

	for my $artist (sort { $a->{_sort} cmp $b->{_sort} } @artists)
	{
		$m->out(qq!<div style="margin-bottom: 3px">Artist: !);
		$m->comp("/comp/linkartist", artist => $artist);
		$m->out(qq!</div>!);

		my @releases = @{ $artist->{_releases} };
		$_->{_sort} = MusicBrainz::Server::Validation::NormaliseSortText($_->GetName)
			for @releases;

		for my $release (sort { $a->{_sort} cmp $b->{_sort} } @releases)
		{
			$m->comp("/comp/album", artist => $artist, album => $release, showrelationships => 0);
		}
	}

	$m->out(qq!</td></tr>!);
	$m->out(qq!</table>!);

</%perl>
</%def>

%# vi: set ts=4 sw=4 ft=mason :
