<%perl>
	# -----------------------------------------------------------------------------
	#                               Musicbrainz.org
	#                        Copyright (c) 2001 Robert Kaye
	# -----------------------------------------------------------------------------
	#  This software is provided "as is", without warranty of any kind, express or
	#  implied, including  but not limited  to the warranties of  merchantability,
	#  fitness for a particular purpose and noninfringement. In no event shall the
	#  authors or  copyright  holders be  liable for any claim,  damages or  other
	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
	#  from,  out of  or in  connection with  the software or  the  use  or  other
	#  dealings in the software.
	#
	#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
	#  Permits anyone the right to use and modify the software without limitations
	#  as long as proper  credits are given  and the original  and modified source
	#  code are included. Requires  that the final product, software derivate from
	#  the original  source or any  software  utilizing a GPL  component, such  as
	#  this, is also licensed under the GPL license.
	# -----------------------------------------------------------------------------
	#
	# Summary:
	# -----------------------------------------------------------------------------
	# Render the release events section of the release editor form.
	#
	# $Id$
	#
</%perl>
<%args>

	$tabindex
	%checkreleases

</%args>
<%perl>

	my $j;
	my $addMore = ($ARGS{"submitvalue"} eq $ARGS{"SUBMIT_ADDRELEASEEVENT"} ? 1 : 0);
	my $num_releases = $checkreleases{"num"} || 0;
	my $errors = $ARGS{"v::releases_errors"};

	# TODO: this should be moved to check-releases.
	# Add a pseudo entry at the end if either the 'More releases' button
	# has been clicked or the list is empty.
	if ($num_releases == 0 or $addMore)
	{
		$j = $num_releases++;
		$ARGS{"rev_year-$j"} = "";
		$ARGS{"rev_month-$j"} = "";
		$ARGS{"rev_day-$j"} = "";
		$ARGS{"rev_country-$j"} = "";
		$ARGS{"rev_catno-$j"} = "";
		$ARGS{"rev_barcode-$j"} = "";
		$ARGS{"rev_label-$j"} = "";
	}

</%perl>

				<tr class="spaced top">
					<td colspan="7" class="formsection">
						<div style="width: 600px; margin-bottom: 10px">
							The fields below allow you to modify release events. The country is preset
							to the one you can specify in the <a href="/user/preferences.html">user
							preferences</a>. A set of fields without dates and the default release
							country is handled as if all fields were blank. If you want to remove
							existing release events, activate the remove button on the left of
							the fields.
						</div>
					</td>
				</tr>
				<tr class="top">
					<td colspan="7" class="formsection">
					<table class="formstyle" border="0" cellspacing="0" cellpadding="0">
					<tr>
						<td colspan="2"></td>
						<td><& /comp/linkdoc, "ReleaseDate", "Date", 0, 1 &> <strong>(<abbr title="Year">Y</abbr>/<abbr title="Month">M</abbr>/<abbr title="Day">D</abbr>):</td>
						<td><& /comp/linkdoc, "ReleaseCountry", "Country", 0, 1 &>:</td>
						<td colspan="2"><& /comp/linkdoc, "Label", "Label", 0, 1 &></td>
						<td><& /comp/linkdoc, "ReleaseCatalogNumber", "Catalog #", 0, 1 &>:</td>
						<td><& /comp/linkdoc, "BarCode", "Barcode", 0, 1 &>:</td>
						<td><& /comp/linkdoc, "ReleaseFormat", "Format", 0, 1 &>:</td>
					</tr>

<%perl>
	my $countries_menu = $m->comp("/edit/albumreleases/countries-menu.inc");
	my $countries_menu_2 = [ [ "", "Select country..." ], @$countries_menu ];
	my $formats_menu = MusicBrainz::Server::ReleaseEvent::GetReleaseFormats();

	for ($j=0; $j < $num_releases; ++$j)
	{
		my $ry = $ARGS{"rev_year-$j"};
		my $rm = $ARGS{"rev_month-$j"};
		my $rd = $ARGS{"rev_day-$j"};
		my $rc = $ARGS{"rev_country-$j"};
		my $rn = $ARGS{"rev_catno-$j"};
		my $rb = $ARGS{"rev_barcode-$j"};
		my $rf = $ARGS{"rev_format-$j"};
		my $rev_label = $ARGS{"rev_label-$j"};
		my $rev_labelname = $ARGS{"rev_labelname-$j"};
		my $rev_labelorigname = $ARGS{"rev_labelorigname-$j"};
		my $rid = $ARGS{"rev_id-$j"};
		my $revdel = $ARGS{"rev_clear-$j"} || 0;

		# lets see if we have to highlight the fields
		my $datecss = $checkreleases{"baddate$j"} ? "-missing" : "";
		my $barcodecss = $checkreleases{"badbarcode$j"} ? "-missing" : "";
		my $countrycss = $checkreleases{"badcountry$j"} ? qq!class="country missing"! : 'class="country"';
		my $countryenabled = $revdel ? qq!disabled="disabled"! : "";

		# load default country from userprefs if country is ""
		$rc = UserPreference::get('default_country')
			if ($rc eq "");

		my $label = "";
		$label .= " [!]" if ($checkreleases{"baddate$j"} or
							 $checkreleases{"badcountry$j"});

</%perl>
				<tr>
					<td><% $label %></td>
					<td>
						<& /comp/form/checkbox, name => "rev_clear-$j", tabindex => ++$$tabindex, checked => $revdel,
							title => "Tick this box to remove this release event" &>
					</td>
					<td nowrap="nowrap">
						<& /comp/form/numberfield, type => "yearfield", name => "rev_year-$j",
							cssclass => $datecss, tabindex => ++$$tabindex, value => $ry, size => 4, maxlength => 4,
							enabled => !$revdel &>
						<& /comp/form/numberfield, type => "monthfield", name => "rev_month-$j",
							cssclass => $datecss, tabindex => ++$$tabindex, value => $rm, size => 2, maxlength => 2,
							enabled => !$revdel &>
						<& /comp/form/numberfield, type => "dayfield", name => "rev_day-$j",
							cssclass => $datecss, tabindex => ++$$tabindex, value => $rd, size => 2, maxlength => 2,
							enabled => !$revdel &>
					</td>
					<td>
						<select name="rev_country-<% $j %>" tabindex="<% ++$$tabindex %>" <% $countrycss |n %> <% $countryenabled |n %>>
							<& /comp/options, $countries_menu_2, $rc &>
						</select>
					</td>
					<td id="labelcheckbox<%  $j %>"></td>
					<td>
						<& /comp/form/hiddenfield, "rev_labelorigname-$j", $rev_labelorigname &>
						<& /comp/form/hiddenfield, "rev_label-$j", $rev_label &>
						<span id="labelinput<%  $j %>">
						<& /comp/form/numberfield, type => "shorttxtfield", name => "rev_labelname-$j",
							tabindex => ++$$tabindex, value => $rev_labelname, size => 15, maxlength => 255,
							enabled => !$revdel, cssclass => " labelname" &></span>
					</td>
					<td>
						<& /comp/form/numberfield, type => "shorttxtfield", name => "rev_catno-$j",
							tabindex => ++$$tabindex, value => $rn, size => 12, maxlength => 255,
							enabled => !$revdel &>
					</td>
					<td>
						<& /comp/form/numberfield, type => "shorttxtfield", name => "rev_barcode-$j",
							tabindex => ++$$tabindex, value => $rb, size => 12, maxlength => 255,
							enabled => !$revdel, cssclass => $barcodecss &>
						<& /comp/form/hiddenfield, "rev_id-$j", $rid &>
					</td>
					<td>
						<select name="rev_format-<% $j %>" tabindex="<% ++$$tabindex %>" style="width: 9em">
							<& /comp/options, $formats_menu, $rf &>
						</select>
					</td>
				</tr>
% 	}
				<tr>
					<td colspan="2">&nbsp;</td>
					<td colspan="6">
						<& /comp/form/buttonsubmit, value => $ARGS{"SUBMIT_ADDRELEASEEVENT"},
							tabindex => ++$$tabindex, id => "btnAddReleaseEvent" &>
					</td>
				</tr>
					</table>
					</td>
				</tr>



%	if (keys %checkreleases > 1)
%	{

				<tr>
					<td colspan="3">&nbsp;</td>
					<td colspan="4">
						<& /comp/form/feedbackbox, "warning", "",
							qq!Please enter valid release events (including the country)
							   or clear the fields you do not want to enter.
							   The missing/wrong date and country fields are marked
							   with a background color and an exclamation mark [\!].! &>
%						if (@$errors) {
							<& /comp/form/feedbackbox, "warning", "", "<ul><li>" . join("</li><li>", @$errors) . "</li></ul>" &>
%						}
					</td>
				</tr>

% 	}

%# vi: set ts=4 sw=4 ft=mason :
