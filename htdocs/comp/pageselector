<%perl>

# I used to have an %args block here but Mason kept crashing on it
my $offset = $ARGS{offset};
my $pagesize = $ARGS{pagesize};
my $url = $ARGS{url};
my $args = $ARGS{args};
my $numitems = $ARGS{numitems};
my $numlinks = $ARGS{numlinks} || 6;
my $snaptoend = $ARGS{snaptoend} || 2;

my $index = int($offset / $pagesize);
my $pagecount = int(($numitems+$pagesize-1) / $pagesize);
return undef if ($pagecount <= 1);

my $start = $index - $numlinks;
if ($start < $snaptoend) { $start = 0 }

my $end = $index + $numlinks;
if ($end > $pagecount-1-$snaptoend) { $end = $pagecount-1 }

my $qsargs = $m->comp(
	"/comp/args-to-querystring.inc",
	%$args,
	offset => undef,
	page => undef,
);

my $urlqs = $url . "?";
$urlqs .= $qsargs . "&"
	unless $qsargs eq "";

</%perl>

<table width="100%" style="margin: 0.2em 0"><tr>
<td align="center" valign="middle" style="border: none" NOWRAP>
<form method="get" action="<% $url %>">
	<& /comp/args-to-hidden-fields.inc, %$args &>
	[ Page
	<input type="text" name="page" value="<% $index+1 %>"
		style="
			width: 2em;
			border: 0;
			color: #534D8B;
			text-align: center;
			padding: 0;
			vertical-align: middle;
		">
	of <% $pagecount %> ]
</form>
</td>
<td align="center" valign="middle" style="border: none">
% if ($index > 0) {
    <a href="<% $urlqs %>offset=0"
    	title="first page"
    	>&lt;&lt;</a>&nbsp;
    <a href="<% $urlqs %>offset=<% ($index - 1) * $pagesize %>"
    	title="previous page"
    	>&lt;</a>&nbsp;
% } else {
    &lt;&lt;
    &lt;
% }

  &nbsp;

<%perl>

$m->out("...&nbsp;") if $start > 0;

for my $i ($start .. $end)
{
	if ($i != $index)
	{
		$m->out("<a href='"
			. encode_entities($urlqs)
			. "offset=" . ($i * $pagesize)
			. "'>" . ($i + 1) . "</a>&nbsp;");
	}
	else
	{
		$m->out("<b>" . ($i + 1) . "</b>&nbsp;");
	}
}

$m->out("...") if $end < $pagecount - 1;

</%perl>

% if ($index < $pagecount - 1) {
    <a href="<% $urlqs %>offset=<% ($index + 1) * $pagesize %>"
    	title="next page"
    	>&gt;</a>&nbsp;
    <a href="<% $urlqs %>offset=<% ($pagecount - 1) * $pagesize %>"
    	title="last page"
    	>&gt;&gt;</a>&nbsp;
% } else {
    &gt;
    &gt;&gt;
% }

</td></tr></table>


%# vi: set ts=4 sw=4 ft=mason :
