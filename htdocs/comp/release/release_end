<%perl>
	# -----------------------------------------------------------------------------
	#                               Musicbrainz.org
	#                        Copyright (c) 2001 Robert Kaye
	# -----------------------------------------------------------------------------
	#  This software is provided "as is", without warranty of any kind, express or
	#  implied, including  but not limited  to the warranties of  merchantability,
	#  fitness for a particular purpose and noninfringement. In no event shall the
	#  authors or  copyright  holders be  liable for any claim,  damages or  other
	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
	#  from,  out of  or in  connection with  the software or  the  use  or  other
	#  dealings in the software.
	#
	#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
	#  Permits anyone the right to use and modify the software without limitations
	#  as long as proper  credits are given  and the original  and modified source
	#  code are included. Requires  that the final product, software derivate from
	#  the original  source or any  software  utilizing a GPL  component, such  as
	#  this, is also licensed under the GPL license.
	# -----------------------------------------------------------------------------
	#
	# Summary:
	# -----------------------------------------------------------------------------
	# Render the Disc IDs, and Release Events of a release
	#
	# $Id$
	#
</%perl>
<%args>

	$artist
	$album

	$showdiscids
	$showreleaseevents

	$showeditlinks
	$releaseevents => undef

	$showtrackartists

</%args>
<%perl>

	my $release = $album;

	my $releaseid = $release->GetId;
	my $isva = $release->HasMultipleTrackArtists || $showtrackartists;

	if ($showdiscids)
	{
		my @ids = @{ $release->GetDiscIDs };

		if (scalar(@ids) > 0)
		{

			foreach my $id (@ids)
			{
				my $cdtoc = $id->GetCDTOC;
				my $duration = MusicBrainz::Server::Track::FormatTrackLength($cdtoc->GetLeadoutOffset / 75 * 1000);
				my $id_numtracks = $cdtoc->GetTrackCount;
				my $discid = $cdtoc->GetDiscID;
				my $degraded = $cdtoc->IsDegraded;
				my $mismatch = (defined $id_numtracks and
							 	$id_numtracks != $release->GetTrackCount);

				# 1. TOC
				my $colspan = ($isva ? 3 : 2);
</%perl>
				<tr class="discid">
					<td class="toc" colspan="<% $colspan %>">Disc ID:

%				$m->out(qq!<span class="mp">!) if ($id->GetModPending);

						<a href="/show/cdtoc/?cdtocid=<% $cdtoc->GetId %>"><% $discid %></a>
%				if ($degraded) {
                       (<a href="/doc/DegradedTOCs">degraded</a>)
%				}

%				# print a warning if the toc has different number of tracks
%				# than the release.
%				if ($mismatch) {
						<span class="mismatch">
							<br />This id belongs to a release that has <% $id_numtracks %> tracks.
						</span>
%				}
%				$m->out(qq!</span>!) if ($id->GetModPending);

					</td>

					<td class="length"><% $duration %></td>

%				# 3. Edit Links
%				if ($session{"uid"} and $showeditlinks)
%				{
%					my $tocid = $cdtoc->GetId();

					<td class="links">
						<a href="/edit/discid/move.html?tocid=<% $tocid %>&amp;releaseid=<% $releaseid %>"
							title="Move DiscID to another release">Move</a> |

						<a href="/edit/discid/remove.html?tocid=<% $tocid %>&amp;releaseid=<% $releaseid %>"
							title="Remove this DiscID from the release">Remove</a>
					</td>
%				}
				</tr>
%			}
%		}
%	}
	</table>


%	if ($showreleaseevents and not $release->IsNonAlbumTracks)
%	{

	<table id="releaseevents::<% $releaseid %>" class="releaseevents">
		<tr valign="top">
			<td class="eventslist">

%		my @relevents = $releaseevents ? @$releaseevents : $release->ReleaseEvents(1);
%		if (@relevents == 0)
%		{

			No release events

%		}
%		else
%		{
%			my %country_names;
%			my $country_obj = MusicBrainz::Server::Country->new($release->{DBH});

				<table class="eventslist">
					<tr>
						<th>Date</th>
						<th>Country</th>
						<th>Label</th>
						<th>Catalog #</th>
						<th>Barcode</th>
						<th>Format</th>
					</tr>

%			my $first = 1;
%			for my $rel (@relevents)
%			{
%				# Country
%				my $cid = $rel->GetCountry;
%				my $name = (
%					$country_names{$cid} ||= do {
%						my $c = $country_obj->newFromId($cid);
%						$c ? $c->GetName : "?";
%					}
%				);

					<tr <% $rel->GetModPending ? qq! class="mp"! : "" |n %>>
						<td><& /comp/releasedate, $rel &></td>
						<td><% $name %></td>
%						if ($rel->GetLabel)
%						{
							<td><& /comp/linklabel, id => $rel->GetLabel, name => $rel->GetLabelName,
								mbid => $rel->GetLabelMBId &></td>
%						}
%						else
%						{
							<td>-</td>
%						}
						<td><% $rel->GetCatNo ? $rel->GetCatNo : "-" %></td>
						<td><% $rel->GetBarcode ? $rel->GetBarcode : "-" %></td>
						<td><% $rel->GetFormat ? $rel->GetFormatName : "-" %></td>
					</tr>
%			}

				</table>

%		}

			</td>

%		if ($session{"uid"} and $showeditlinks)
%		{

			<td class="links">
				<a href="/edit/albumreleases/index.html?releaseid=<% $releaseid %>"
					title="Add, edit and remove release events of this release">Edit release events</a></td>

%		}

		</tr>
	</table>

%	}

%	# add some spacing after the release.
	<div class="release_endspacer">&nbsp;</div>

%# vi: set ts=4 sw=4 ft=mason :
