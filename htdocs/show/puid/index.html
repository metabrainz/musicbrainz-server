<%perl>
	# -----------------------------------------------------------------------------
	#										 Musicbrainz.org
	#								Copyright (c) 2001 Robert Kaye
	# -----------------------------------------------------------------------------
	#  This software is provided "as is", without warranty of any kind, express or
	#  implied, including  but not limited  to the warranties of  merchantability,
	#  fitness for a particular purpose and noninfringement. In no event shall the
	#  authors or  copyright  holders be  liable for any claim,  damages or  other
	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
	#  from,  out of  or in  connection with  the software or  the  use  or  other
	#  dealings in the software.
	#
	#  GPL - The GNU General Public License	 http://www.gnu.org/licenses/gpl.txt
	#  Permits anyone the right to use and modify the software without limitations
	#  as long as proper  credits are given  and the original  and modified source
	#  code are included. Requires  that the final product, software derivate from
	#  the original  source or any  software  utilizing a GPL  component, such  as
	#  this, is also licensed under the GPL license.
	# -----------------------------------------------------------------------------
	#
	# Summary:
	# -----------------------------------------------------------------------------
	# List all releases with tracks that have the given PUID attached.
	#
	# $Id$
	#
</%perl>
<%args>

	$puid => undef
	$matchesonly => 1

</%args>

<& /comp/sidebar-notitle, pagetitle => "Show PUID" &>

<%perl>

	my $showreleases = 0;
	my $showspecial = undef;

    my $mb = $m->comp("/comp/dblogin");
    my $artist = MusicBrainz::Server::Artist->new($mb->{DBH});
    my $release = MusicBrainz::Server::Release->new($mb->{DBH});
    my $pweed = MusicBrainz::Server::PUID->new($mb->{DBH});
	my $ids;

	unless (MusicBrainz::Server::Validation::IsGUID($puid))
	{
		$showspecial = "The argument <strong>puid</strong> is missing or has an invalid format";
	}
	else
	{
		$puid = lc $puid;
    	$ids = $pweed->GetTrackIdsFromPUID($puid);
		if (scalar(@$ids) == 0)
		{
			$showspecial = "This <strong>PUID</strong> was not found in the database";
		}
		else
		{
			$showreleases = 1;
		}
	}

	if ($showreleases || $showspecial)
	{
		if ($matchesonly || $showspecial)
		{

</%perl>

	<& /comp/tablebegin, title => "Show PUID ".lc($puid) &>

		<table class="formstyle">
			<tr>
				<td class="instructions">
					<ul>

%			if ($matchesonly && $showreleases) {

						<li>
							Please note, that only tracks with the specified PUID
							are shown below. Click on <strong>Show all tracks</strong>
							to get the complete track listings.<br/>
							<form method="get" action="/show/puid/">
								<div style="margin-top: 5px">
									<input type="hidden" name="puid" value="<% $puid %>" />
									<input type="hidden" name="matchesonly" value="0" />
									<input type="submit" value="Show all tracks &raquo;" />
								</div>
							</form></li>
%			}

%			if ($showspecial)
%			{
						<li>
							<% $showspecial |n %>.</li>
%			}
					</ul></td>
			</tr>
		</table>

	<& /comp/tableend &>

<%perl>

		}

		if ($showreleases)
		{
			my %artists;
			my %releases;

			for my $info (@$ids)
			{
				my @releases = $release->GetReleaseIdsFromTrackId($info->{track});
				for my $releaseid (@releases)
				{
					$releases{$releaseid} ||= do {
						my $release = MusicBrainz::Server::Release->new($mb->{DBH});
						$release->SetId($releaseid);
						$release->LoadFromId
							or $release = "0 but true"; # load failed
						$release;
					};
					ref(my $release = $releases{$releaseid})
						or next;

					$artists{$release->GetArtist} ||= do {
						my $artist = MusicBrainz::Server::Artist->new($mb->{DBH});
						$artist->SetId($release->GetArtist);
						$artist->LoadFromId
							or $artist = "0 but true"; # load failed
						$artist;
					};
					ref(my $artist = $artists{$release->GetArtist})
						or next;

					$artist->{_my_releases_}{$releaseid} ||= $release;
					$release->{_my_tracks_}{$info->{track}} = { puidjoin => $info->{puidjoin} };
				}
			}

			# For each artist in sortname order...
			my @artist = values %artists;
			@artist = map {
					$_->[0]
				} sort {
					$a->[1] cmp $b->[1]
				} map {
					my $n = MusicBrainz::Server::Validation::NormaliseSortText($_->GetSortName);
					[ $_, $n ];
				} @artist;

			for my $artist (@artist)
			{
				$m->comp("/comp/artisttitle", artist => $artist);

				# For releases in name order...
				my @release = values %{ $artist->{_my_releases_} };
				@release = map {
						$_->[0]
					} sort {
						$a->[1] cmp $b->[1]
					} map {
						my $n = MusicBrainz::Server::Validation::NormaliseSortText($_->GetName);
						[ $_, $n ];
					} @release;

				for my $release (@release)
				{
					$m->comp("/comp/album",
						album => $release, artist => $artist,
						showlinks => 0, showmodlinks => 0, showrelationships => 0,
						highlighttracks	=> $release->{_my_tracks_}, highlightonly => $matchesonly,
					);
					if ($session{uid} && scalar(keys %{$release->{_my_tracks_}}))
					{
						my $seq;
						for my $tr (keys %{$release->{_my_tracks_}})
						{
							foreach my $t (@{$release->{_tracks}})
							{
								if ($t->{id} ==$tr)
								{
									$release->{_my_tracks_}->{$tr}->{sequence} = $t->{sequence};
									last;
								}
							}
						}
						$m->out("<ul>");
						for my $tr (sort { $release->{_my_tracks_}->{$a}->{sequence} <=> 
								           $release->{_my_tracks_}->{$b}->{sequence} } keys %{$release->{_my_tracks_}})
						{
							$m->out('<li><a href="/edit/puid/remove.html?trackid='. $tr.'&puid='. $puid .
									'&PUIDjoin='.$release->{_my_tracks_}->{$tr}->{puidjoin}.
									'">Remove PUID from track '.$release->{_my_tracks_}->{$tr}->{sequence}.'</a></li>');
						}
						$m->out("</ul>");
					}
				}
			}
		}

	}
	$mb->Logout;

</%perl>

<& /comp/footer &>

%# vi: set ts=4 sw=4 ft=mason :
