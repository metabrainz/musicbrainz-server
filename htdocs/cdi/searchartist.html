<%perl>
	# -----------------------------------------------------------------------------
	#                               Musicbrainz.org
	#                        Copyright (c) 2001 Robert Kaye
	# -----------------------------------------------------------------------------
	#  This software is provided "as is", without warranty of any kind, express or
	#  implied, including  but not limited  to the warranties of  merchantability,
	#  fitness for a particular purpose and noninfringement. In no event shall the
	#  authors or  copyright  holders be  liable for any claim,  damages or  other
	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
	#  from,  out of  or in  connection with  the software or  the  use  or  other
	#  dealings in the software.
	#
	#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
	#  Permits anyone the right to use and modify the software without limitations
	#  as long as proper  credits are given  and the original  and modified source
	#  code are included. Requires  that the final product, software derivate from
	#  the original  source or any  software  utilizing a GPL  component, such  as
	#  this, is also licensed under the GPL license.
	# -----------------------------------------------------------------------------
	#
	# Summary:
	# -----------------------------------------------------------------------------
	# Search for an artist to which the release will be attributed to.
	#
	# $Id$
	#
</%perl>
<%args>

	$discid => undef
	$toc => undef
	$tracks => undef
	$search => ""
	$artistid => 0
	$submitvalue => ""
	$barcode => undef

</%args>
<%perl>

	# only logged in users with a valid e-mail address can
	# see this page.
	$m->comp("/comp/checkloggedin", 1, 1)
		or return;

	# make sure we got a valid toc parameter
	MusicBrainz::Server::Validation::IsSingleLineString($toc) && $toc ne ""
		or return $m->comp("/comp/layout/badarguments",
			text => "The argument <strong>toc</strong> is missing or has a wrong format.");

	# make sure we got a valid releaseid parameter
	MusicBrainz::Server::Validation::IsSingleLineString($discid) && $discid ne ""
		or return $m->comp("/comp/layout/badarguments",
			text => "The argument <strong>discid</strong> is missing or has a wrong format.");

	# make sure we got a valid tracks parameter
	MusicBrainz::Server::Validation::IsNonNegInteger($tracks) && $tracks
		or return $m->comp("/comp/layout/badarguments",
			text => "The argument <strong>tracks</strong> is missing or has a wrong format.");

	# if the submitvalue is an array, the user has
	# clicked the "Select »" button. There is a hidden field
	# in the form, because if the user doubleclicks on
	# radio-button, the submitvalue of the button is not
	# transmitted, therefore the hidden field.
	$submitvalue = (ref($submitvalue) eq "ARRAY" ? @$submitvalue[0] : $submitvalue);

	if ($submitvalue ne "")
	{
		my %args = %ARGS;
		delete $args{"submitvalue"};
		delete $args{"search"};
		delete $args{"artistfilter_newartistid"};
		delete $args{"artistfilter_field"};
		delete $args{"barcode"} unless $barcode;

		if ($submitvalue =~ m/Add New Artist/i)
		{

			# prepare, and escape returnurl. artistfilter_newartistid will reference the
			# artistid being added in the ADD ARTIST editor.
			my $returnurl = "/cdi/searchartist.html?".$m->comp("/comp/args-to-querystring.inc", %args);
			$returnurl .= "&artistid=";
			$returnurl = uri_escape($returnurl);
			$search = uri_escape($search);

			my $addartisturl = "/edit/artist/add.html?name=$search&returnurl=$returnurl";
			return $m->comp("/comp/redirect", $addartisturl);
		}
		elsif ($submitvalue =~ m/Search/)
		{
		}
		elsif ($submitvalue =~ m/Cancel/)
		{
			delete $args{"discid"};
			delete $args{"tracks"};
			my $nexturl = "/bare/cdlookup.html?".$m->comp("/comp/args-to-querystring.inc", %args);

			return $m->comp("/comp/redirect", $nexturl);
		}
		elsif ($submitvalue =~ m/Select/)
		{
			$args{"artistid"} = $ARGS{"artistfilter_newartistid"};
			my $nexturl = "/cdi/searchartistrelease.html?".$m->comp("/comp/args-to-querystring.inc", %args);

			return $m->comp("/comp/redirect", $nexturl);
		}
	}

</%perl>

<& /comp/sidebar-notitle, pagetitle => "Search for release artist" &>

	<& /comp/tablebegin, title => "Search for release artist" &>

        <form method="post" action="/cdi/searchartist.html">

			<& /comp/form/steps,
				steps => ["Lookup CD", "Select artist", "Attach Disc ID"],
				curr => 1
			&>

			<table class="formstyle">

				<& /comp/artistfilter, search => $search &>

			</table>

			<input type="hidden" name="submitvalue" value="Select &raquo;" />
			<input type="hidden" name="discid" value="<% $discid %>" />
			<input type="hidden" name="toc" value="<% $toc %>" />
			<input type="hidden" name="tracks" value="<% $tracks %>" />
			<input type="hidden" name="barcode" value="<% $barcode %>" />
        </form>

	<& /comp/tableend &>

<& /comp/footer &>

%# vi: set ts=4 sw=4 ft=mason :
