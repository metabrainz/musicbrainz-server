<%perl>
	# -----------------------------------------------------------------------------
	#                               Musicbrainz.org
	#                        Copyright (c) 2001 Robert Kaye
	# -----------------------------------------------------------------------------
	#  This software is provided "as is", without warranty of any kind, express or
	#  implied, including  but not limited  to the warranties of  merchantability,
	#  fitness for a particular purpose and noninfringement. In no event shall the
	#  authors or  copyright  holders be  liable for any claim,  damages or  other
	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
	#  from,  out of  or in  connection with  the software or  the  use  or  other
	#  dealings in the software.
	#
	#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
	#  Permits anyone the right to use and modify the software without limitations
	#  as long as proper  credits are given  and the original  and modified source
	#  code are included. Requires  that the final product, software derivate from
	#  the original  source or any  software  utilizing a GPL  component, such  as
	#  this, is also licensed under the GPL license.
	# -----------------------------------------------------------------------------
	#
	# Summary:
	# -----------------------------------------------------------------------------
	# Search for releases to attribute a DiscID to.
	#
	# $Id$
	#
</%perl>
<%args>

	$discid
	$toc
	$barcode
	$search
	$tracks => undef
	$showallreleases => 0

</%args>
<%perl>

	# only logged in users with a valid e-mail address can
	# see this page.
	$m->comp("/comp/checkloggedin", 1, 1)
		or return;

	$m->comp("/comp/sidebar-notitle", pagetitle => "Select release");

	# make sure we got a valid toc parameter
	MusicBrainz::Server::Validation::IsSingleLineString($toc) && $toc ne ""
		or return $m->comp("/comp/layout/badarguments",
			text => "The argument <strong>toc</strong> is missing or has a wrong format.");

	# make sure we got a valid releaseid parameter
	MusicBrainz::Server::Validation::IsSingleLineString($discid) && $discid ne ""
		or return $m->comp("/comp/layout/badarguments",
			text => "The argument <strong>discid</strong> is missing or has a wrong format.");

	# make sure we got a valid tracks parameter
	MusicBrainz::Server::Validation::IsNonNegInteger($tracks) && $tracks
		or return $m->comp("/comp/layout/badarguments",
			text => "The argument <strong>tracks</strong> is missing or has a wrong format.");

	# Instantiate MusicBrainz object
	my $mb = $m->comp("/comp/dblogin");

	# Maintain a list of Artists cached by ID.
	my $GetCachedArtist = do
	{
		my %cache;
		sub
		{
			my ($id) = @_;
			return $cache{$id} if (exists $cache{$id});
			my $artist = $m->comp("/comp/loadartist", $mb, $id);
			return ($cache{$id} = $artist);
		};
	};

	my %usedartists = ();
	my %unusedartists = ();
	my ($countused,  $countunused);

	# Search for releases using the SearchEngine
	my $eng = SearchEngine->new($mb->{DBH}, "album");
	$eng->Search(
		query => $search,
		limit => 0,
	);

	if ($eng->Rows > 0)
	{
		my @row;
		while (my $row = $eng->NextRow)
		{
			my $release = $m->comp("/comp/loadrelease", $mb, $row->{'albumid'});
			next if $release->IsNonAlbumTracks;

			# TODO move this method to somewhere more suitable
			$release->{_name_} = Moderation->_normalise_strings($release->GetName);

			my $artistid = $release->GetArtist;
			my $artist = &$GetCachedArtist($artistid);

			if ($release->GetTrackCount() == $tracks)
			{
				unless ($usedartists{$artistid})
				{
					$usedartists{$artistid} = $artist;
					$artist->{"_sortname_"} = Moderation->_normalise_strings($artist->GetSortName);
				}

				push @{ $usedartists{"$artistid"}{"_used_"} }, $release;
				$countused++;
			}
			else
			{
				unless ($unusedartists{$artistid})
				{
					$unusedartists{$artistid} = $artist;
					$artist->{"_sortname_"} = Moderation->_normalise_strings($artist->GetSortName);
				}
				push @{ $unusedartists{"$artistid"}{"_unused_"} }, $release;
				$countunused++;
			}
		}
	}

	if ($countused)
	{
		my $title = "Found $countused release";
		$title .= ($countused == 1 ? "" : "s");
		$title .= " With $tracks Track";
		$title .= ($tracks == 1 ? "" : "s");

</%perl>

	<& /comp/tablebegin, title => $title &>

		<& /comp/form/steps,
			steps => ["Lookup CD", "Select release", "Attach Disc ID"],
			curr => 1 &>

		<table class="formstyle">
			<tr>
				<td>
					<ul>
						<li>
							Please examine the releases listed below. If one of
							the track listings matches the release that you are submitting,
							click on the <strong>Select release &raquo;</strong>
							button next to the matching release to attach the
							table of contents information of your media to
							this release.</li>
						<li>
							If none of the listed releases match, click on
							the <strong>Enter new release &raquo;</strong> button
							below to enter your copy into MusicBrainz.</li>
						<li>
							If you are unsure as to which one to pick or you have
							questions about this step, please check out our <& /comp/linkdoc,
							"DiscSubmission", "CD submission document" &> for more details
							on the submission process. The <& /comp/linkdoc, "DiscID",
							"Disc ID" &> for the CD you have looked up is <strong><% $discid %></strong>.</li>
					</ul>
				</td>
			</tr>
		</table>

	<& /comp/tableend &>

	<table cellspacing="0" cellpadding="0" border="0" style="width: 80%">

%		for my $artist (sort { $a->{"_sortname_"} cmp $b->{"_sortname_"} } values %usedartists)
%		{

		<tr valign="top">
			<td colspan="3" style="width: 100%">

%				# render artist link only, instead of comp/artisttitle
				<div style="margin-bottom: 3px">Artist:
					<& /comp/linkartist, artist => $artist &>
				</div>
			</td>
		</tr>

%			for my $release (sort { $a->{_name_} cmp $b->{_name_} } @{ $artist->{"_used_"} })
%			{

		<tr valign="top">
			<td style="width: 100%; padding-left: 47px; padding-bottom: 10px">
				<& /comp/album, album => $release, artist => $artist, showmodlinks => 0, showrelationships => 0 &>
			</td>
			<td>&nbsp;&nbsp;&nbsp;</td>
			<td align="right">
				<form method="post" action="/cdi/selectrelease.html">
					<div>
						<input type="submit" class="button" value="Select Release &raquo;" />
						<input type="hidden" name="releaseid" value="<% $release->GetId() %>" />
						<input type="hidden" name="discid" value="<% $discid %>" />
						<input type="hidden" name="toc" value="<% $toc %>" />
						<input type="hidden" name="tracks" value="<% $tracks %>" />
						<input type="hidden" name="barcode" value="<% $barcode %>" />
					</div>
				</form>
			</td>
		</tr>

%			}
%		}

	</table>


%	}
%	elsif ($search ne "")
%	{

	<& /comp/tablebegin, title => "No releases matching the search found with $tracks tracks" &>

		<table class="formstyle">
			<tr>
				<td>
					<ul>
						<li>There were no releases with <% $tracks %> tracks found. </li>
						<li>Please click on the <strong>Enter new release &raquo;</strong>
							button if you want to add your copy to MusicBrainz.</li>
					</ul>
				</td>
			</tr>
		</table>

	<& /comp/tableend &>

%	}

</%perl>

	<& /comp/tablebegin, title => "Search for release" &>

		<table class="formstyle">
			<tr>
				<td class="label">Search for:</td>
				<td>
					<form method="post" action="searchrelease.html">
						<div>
							<input type="text" name="search" size="25" value="<% $search %>" />
							<input type="submit" value="Search &raquo;" />
							<input type="hidden" name="discid" value="<% $discid %>" />
							<input type="hidden" name="tracks" value="<% $tracks %>" />
							<input type="hidden" name="toc" value="<% $toc %>" />
							<input type="hidden" name="barcode" value="<% $barcode %>" />
						</div>
					</form>
				</td>
			</tr>
		</table>

	<& /comp/tableend &>

%	if ($search ne "")
%	{

	<& /comp/tablebegin, title => "Enter new release" &>

		<& /comp/form/steps,
			steps => ["Lookup CD", "Select release", "Enter information", "Finish"],
			curr => 1 &>

		<table class="formstyle">
			<tr>
				<td class="label">&nbsp;</td>
				<td>
					<form method="post" action="enter.html">
						<div>
							<input type="submit" class="button" value="Enter new release &raquo;" />
							<input type="hidden" name="artistid" value="<% &ModDefs::VARTIST_ID %>" />
							<input type="hidden" name="discid" value="<% $discid %>" />
							<input type="hidden" name="toc" value="<% $toc %>" />
							<input type="hidden" name="tracks" value="<% $tracks %>" />
							<input type="hidden" name="hasmultipletrackartists" value="0" />
							<input type="hidden" name="releasename" value="<% $search %>" />
							<input type="hidden" name="barcode" value="<% $barcode %>" />
						</div>
					</form>
				</td>
			</tr>
		</table>

	<& /comp/tableend &>

%	}
%   if ($countunused)
%	{

	<& /comp/tablebegin, title => "Found $countunused releases with different number of tracks" &>

		<table class="formstyle">
			<tr>
				<td>
					<ul>
						<li><strong>What if my release is listed here?</strong>
							The following releases are not applicable because
							they have a different number of tracks than
							the CD you are submitting. Even though there may be
							a release listed with the same name, there sometimes are
							different editions of the same release which have a
							different number of tracks. (Example: International
							vs. Japan releases / Remastered editions with bonus tracks etc.)</li>
					</ul>
				</td>
			</tr>
		</table>

		<table class="searchresults">
			<tr class="searchresultsheader">
				<td style="width: 40px">Tracks:</td>
				<td>Release title:</td>
				<td>Release artist:</td>
			</tr>

%		my $i = 0;
%		for my $artist (sort { $a->{"_sortname_"} cmp $b->{"_sortname_"} } values %unusedartists)
%		{
%			for my $release (sort { $a->{_name_} cmp $b->{_name_} } @{ $artist->{"_unused_"} })
%			{
%				if ($i == 10)
%				{
%					if (!$showallreleases)
%					{

			<tr>
				<td>&nbsp;</td>
				<td colspan="2">
					<form action="searchrelease.html" method="get">
						<div>
							<input type="submit" value="Show all releases &raquo;" />

							<& /comp/form/hiddenfield, "discid", $discid &>
							<& /comp/form/hiddenfield, "toc", $toc &>
							<& /comp/form/hiddenfield, "tracks", $tracks &>
							<& /comp/form/hiddenfield, "search", $search &>
							<& /comp/form/hiddenfield, "showallreleases", 1 &>
						</div>
					</form>
				</td>
			</tr>

%						last;
%					}
%				}

			<tr class="searchresults<% $i++ % 2 == 0 ? "even" : "odd" %>">
				<td style="width: 40px">
					<img src="/images/notes.gif" alt="" title="Tracks" /> <% $release->GetTrackCount %></td>
				<td>
					<& /comp/linkrelease, release => $release, strong => 0 &></td>
				<td>
					<& /comp/linkartist, artist => $artist, strong => 0 &></td>
			</tr>

%       	}
%		}

		</table>

	<& /comp/tableend &>

%   }

	<& /comp/js/diffcollapse &>

<& /comp/footer &>

%# vi: set ts=4 sw=4 ft=mason :
