<%perl>
	# -----------------------------------------------------------------------------
	#                               Musicbrainz.org
	#                        Copyright (c) 2001 Robert Kaye
	# -----------------------------------------------------------------------------
	#  This software is provided "as is", without warranty of any kind, express or
	#  implied, including  but not limited  to the warranties of  merchantability,
	#  fitness for a particular purpose and noninfringement. In no event shall the
	#  authors or  copyright  holders be  liable for any claim,  damages or  other
	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
	#  from,  out of  or in  connection with  the software or  the  use  or  other
	#  dealings in the software.
	#
	#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
	#  Permits anyone the right to use and modify the software without limitations
	#  as long as proper  credits are given  and the original  and modified source
	#  code are included. Requires  that the final product, software derivate from
	#  the original  source or any  software  utilizing a GPL  component, such  as
	#  this, is also licensed under the GPL license.
	# -----------------------------------------------------------------------------
	#
	# Summary:
	# -----------------------------------------------------------------------------
	# This page allows an user to edit their preferences.
	#
	# $Id$
	#
</%perl>
<%perl>

	# overloaded case of the checkloggedin component:
	# if a user visits this page to edit his preferences
	# he is allowed even if they does not have a verified
	# e-mail address set. (they do not change any of the data
	# that might require other editors to contact them about)
	$m->comp("/comp/checkloggedin", 1, 1,
		"You need to be logged in to modify your preferences.", 1) or return;

	$session{orig_privs} = $session{privs}
		if not exists $session{orig_privs};

	my $saved = 0;

	my $countries_menu = $m->comp("/edit/albumreleases/countries-menu.inc");
	my $countries_menu_2 = [ [ 0, "[none]" ], @$countries_menu ];

	my $mb = $m->comp("/comp/dblogin");
	my $ui = UserStuff->new($mb->{DBH});

	if ($ARGS{"SavePrefs"})
	{
		# Insert zeroes for checkboxes which weren't submitted
		for (qw(
			mod_add_album_inline
			mod_add_album_link
			navbar_mod_show_select_page
			JSMoveFocus
			JSDiff
			JSCollapse
			JSDebug
			reveal_address_when_mailing
			sendcopy_when_mailing
			show_amazon_coverart
			sidebar_panel_search
			sidebar_panel_sites
			sidebar_panel_stats
			sidebar_panel_topmods
			sidebar_panel_user
			nosidebar
			vote_abs_default
			mail_notes_if_i_noted
			mail_notes_if_i_voted
			mail_on_first_no_vote
			remove_recent_link_on_add
			release_show_relationshipslinks
			release_show_annotationlinks
			show_inline_mods
			show_inline_mods_random
			show_ratings
			subscriptions_public
			tags_public
			ratings_public
			auto_subscribe
			css_noentityicons
			css_nosmallfonts
		)) {
			$ARGS{$_} = 0 if not defined $ARGS{$_};
		}

		# added: 2006-5-17: css_noentityicons, css_nosmallfonts
		# --- option to include css which turn off default
		#     rendering.

		for my $key (UserPreference::valid_keys())
		{
			UserPreference::set($key, $ARGS{$key})
				if defined $ARGS{$key};
		}

		$saved = eval { UserPreference::SaveForUser($ui->Current) };

		# Volatile debugging preferences
		if (&DBDefs::DB_STAGING_SERVER) {
			for (qw(
			)) {
				$session{$_} = $ARGS{$_} ? 1 : 0;
			}
		}

		# Other volatile preferences
		if (UserStuff->IsAutoEditor($session{orig_privs}))
		{
			my $p = 0 + $session{privs};

			if ($ARGS{enable_automod_privs}) { $p |= UserStuff->AUTOMOD_FLAG }
			else { $p &= ~(UserStuff->AUTOMOD_FLAG) }

			$session{privs} = $p;
		}

		if (not $saved)
		{
			my $err = $@;
			</%perl>
			<& /comp/sidebar, title => "Error saving preferences" &>
			<div>
				An error occurred while trying to save your preferences.
				Sorry about that.
			</div>
			<& /comp/footer &>
			<%perl>
		}
	}

	require POSIX;
	my $time = POSIX::mktime(24,56,13,31,11,101,0,0,0);

	my @format_list = map {
		[ $_, $m->comp("/comp/datetime", { datetimeformat=> $_, tz=>'UTC' }, $time) ]
	} UserPreference::allowed_datetime_formats();

	$time = time();



	# begin page rendering
	$m->comp("/comp/sidebar-notitle", pagetitle => "Preferences");

	if ($saved)
	{
		$m->comp("/comp/tablebegin", title => "Success");
		$m->out("Your preferences have been saved.");
		$m->comp("/comp/tableend");
	}
</%perl>

	<form method="post" action="/user/preferences.html" id="PreferencesForm">
		<div>
			<input type="hidden" name="SavePrefs" value="1" />

			<& /comp/tablebegin, title => "Voting/Edit review pages" &>

				<div>
					<input type="checkbox" name="mod_add_album_inline" id="pref_mod_add_album_inline"
%						$m->out(UserPreference::get('mod_add_album_inline') ? ' checked="checked" ' : "");
						onclick="this.form.mod_add_album_link.disabled = !this.checked" />
					<label for="pref_mod_add_album_inline">
						For "Add Release" edits, show the whole release</label> ...

					<br /> &nbsp; &nbsp;
					<input type="checkbox" name="mod_add_album_link" id="pref_mod_add_album_link"
%						$m->out(UserPreference::get('mod_add_album_link') ? ' checked="checked" ' : "" );
						/>
					<label for="pref_mod_add_album_link">
						and show editing links.</label>
				</div>

				<div>
					<input type="checkbox" name="navbar_mod_show_select_page" id="pref_navbar_mod_show_select_page"
%						$m->out(UserPreference::get('navbar_mod_show_select_page') ? ' checked="checked" ' : "");
						/>
					<label for="pref_navbar_mod_show_select_page">
						Make the "Vote on Edits" link in the sidebar go to
						<a href="/mod/search/select-filter.html">this page</a>
						instead of the "New edits" list.</label>
				</div>

				<div>
					<label for="pref_mods_per_page">Show up to
					<input type="text" name="mods_per_page" id="pref_mods_per_page" size="3"
						value="<% UserPreference::get('mods_per_page') %>" />
					edits per page (max: 25).</label>
				</div>

				<div>
					<input type="checkbox" name="vote_abs_default" id="pref_vote_abs_default"
%						$m->out(UserPreference::get('vote_abs_default') ? ' checked="checked" ' : "" );
						/>
					<label for="pref_vote_abs_default">
						Abstain by default.</label>
				</div>

				<div>
					<input type="checkbox" name="mail_notes_if_i_noted" id="pref_mail_notes_if_i_noted"
%						$m->out(UserPreference::get('mail_notes_if_i_noted') ? ' checked="checked" ' : "");
						/>
					<label for="pref_mail_notes_if_i_noted">
						When I add a note to an edit , mail me all future notes for that edit.</label>
				</div>

				<div>
					<input type="checkbox" name="mail_notes_if_i_voted" id="pref_mail_notes_if_i_voted"
%						$m->out(UserPreference::get('mail_notes_if_i_voted') ? ' checked="checked" ' : "");
						/>
					<label for="pref_mail_notes_if_i_voted">
						When I vote on an edit, mail me all future notes for that edit.</label>
						<br />
						&nbsp; &nbsp;
						(Note: only takes effect when your most recent vote on a edit is either
						yes or no - not "abstain")
				</div>
				<div>
					<input type="checkbox" name="mail_on_first_no_vote" id="pref_mail_on_first_no_vote"
%						$m->out(UserPreference::get('mail_on_first_no_vote') ? ' checked="checked" ' : "");
						/>
					<label for="pref_mail_on_first_no_vote">
						Mail me when one of my edits gets a "no" vote.</label>
						<br />
						&nbsp; &nbsp;
						(Note: the email is only sent for the first "no" vote, not each one)
				</div>
						

% 	unless ($ui->Current->IsNewbie)
%	{

				<div>
					<input type="checkbox" name="show_inline_mods" id="pref_show_inline_mods"
%						$m->out(UserPreference::get('show_inline_mods') ? ' checked="checked" ' : "");
						/>
					<label for="pref_show_inline_mods">
						Show <em>inline</em> edits at the top of artist/release pages.</label>

%		if (UserStuff->IsAutoEditor($session{orig_privs}))
%		{

					<br />&nbsp; &nbsp;

					<input type="checkbox" name="show_inline_mods_random" id="pref_show_inline_mods_random"
%						$m->out(UserPreference::get('show_inline_mods_random') ? ' checked="checked" ' : "");
						/>
					<label for="pref_show_inline_mods_random">
						Show random <em>inline</em> edits.</label>

%       }

				</div>

% 	}

				<div>
					<input type="checkbox" name="remove_recent_link_on_add" id="pref_remove_recent_link_on_add"
%						$m->out(UserPreference::get('remove_recent_link_on_add') ? ' checked="checked" ' : "");
						/>
					<label for="pref_remove_recent_link_on_add">
						After creating a new relationship, remove the linked items
						from my "recently used" list.</label>
				</div>

				<div>
					<input type="checkbox" name="auto_subscribe" id="pref_auto_subscribe"
%						$m->out(UserPreference::get('auto_subscribe') ? ' checked="checked" ' : "");
						/>
					<label for="pref_auto_subscribe">
						Automatically subscribe me to artists or labels I create.</label>
				</div>

			<& /comp/tableend &>

			<& /comp/tablebegin, title => "E-Mailing other editors" &>

				<div>
					<label for="pref_reveal_address_when_mailing"><input type="checkbox" name="reveal_address_when_mailing" id="pref_reveal_address_when_mailing"
%						$m->out(UserPreference::get('reveal_address_when_mailing') ? ' checked="checked" ' : "");
						/>
					Reveal my e-mail address checked by default.</label>
					[&nbsp;<a href="/popup/RevealMyEmailAddress" title="POPUP::Reveal_My_Email_Address::400::400">help</a>&nbsp;]

				</div>
				<div>
					<label for="pref_sendcopy_when_mailing"><input type="checkbox" name="sendcopy_when_mailing" id="pref_sendcopy_when_mailing"
%						$m->out(UserPreference::get('sendcopy_when_mailing') ? ' checked="checked" ' : "");
						/>
					Send me a copy to my e-mail address.</label>
					[&nbsp;<a href="/popup/SendCopyWhenMailing" title="POPUP::SendCopyWhenMailing::400::400">help</a>&nbsp;]

				</div>

			<& /comp/tableend &>

			<& /comp/tablebegin, title => "Show artist" &>

				<div>
					<label for="pref_releases_show_compact">
					Default to a "compact" listing when there are
					<input type="text" name="releases_show_compact" id="pref_releases_show_compact"
						size="3"
						value="<% UserPreference::get('releases_show_compact') %>"
						/>
					releases or more. (allowed range: 1-100).</label>
				</div>

			<& /comp/tableend &>


			<& /comp/tablebegin, title => "Show release" &>

				<div>
					<label for="pref_release_show_relationshipslinks">
					<input type="checkbox" name="release_show_relationshipslinks" id="pref_release_show_relationshipslinks"
%						$m->out(UserPreference::get('release_show_relationshipslinks') ? ' checked="checked" ' : "");
						/>
					Show the add/edit relationships links in the release header.
                    </label>
				</div>

				<div>
					<label for="pref_release_show_annotationlinks">
					<input type="checkbox" name="release_show_annotationlinks" id="pref_release_show_annotationlinks"
%						$m->out(UserPreference::get('release_show_annotationlinks') ? ' checked="checked" ' : "");
						/>
					Show the add/edit annotation links in the release header.
                    </label>
				</div>

				<div>
					<label for="pref_show_amazon_coverart"><input type="checkbox" name="show_amazon_coverart" id="pref_show_amazon_coverart"
%						$m->out(UserPreference::get('show_amazon_coverart') ? ' checked="checked" ' : "");
						/>
					Show Amazon.com cover art and buy links.
                    </label>
				</div>

				<div style="margin-left: 25px">
					Your preferred Amazon Store:
					<select name="use_amazon_store">
						<& /comp/options, [ UserPreference::allowed_amazon_stores() ],
						UserPreference::get('use_amazon_store') &>
					</select>
				</div>

			<& /comp/tableend &>

			<& /comp/tablebegin, title => "Country" &>

				<div>
					When adding a new release, pick this country by default:
					<select name="default_country">
					<& /comp/options, $countries_menu_2,
						UserPreference::get('default_country'),
						&></select>
				</div>
				<div style="margin-top: 3px">
					Your preferred Google domain:
						<select name="google_domain">
						<& /comp/options,
							[ UserPreference::allowed_google_domains() ],
							UserPreference::get('google_domain'),
							&></select>
				</div>

			<& /comp/tableend &>

			<& /comp/tablebegin, title => "Date/Time display" &>

				<div>
					Your preferred date/time format:
					<select name="datetimeformat">
						<& /comp/options, \@format_list,
						UserPreference::get('datetimeformat') &>
					</select>
				</div>
				<div style="margin-top: 3px">
					Your preferred time zone:
					<select name="timezone">
						<& /comp/options, [ UserPreference::allowed_timezones() ],
						UserPreference::get('timezone') &>
					</select>
				</div>
				<div style="margin-top: 3px">
					The time now (using your preferences) is
					<b><% $m->comp("/comp/datetime", $time) %></b>
					and 180 days' time is
					<b><% $m->comp("/comp/datetime", $time+180*86400) %></b>
				</div>

			<& /comp/tableend &>

			<& /comp/tablebegin, title => "Topmenu configuration" &>

				<div>
					The menu which is placed on top of the pages features multiple ways of
					navigating the site. You can choose which menu type (or both) you'd like to
					see if you are logged in:
					<select name="topmenu_submenu_types">
						<& /comp/options,
							[
								[ "both", "Both" ],
								[ "dropdownonly", "Dropdown menus only (vertical)" ],
								[ "staticonly", "Static submenus only (horizontal)" ],
							],
							UserPreference::get('topmenu_submenu_types') &>
					</select>
				</div>
				<div style="margin-top: 3px">
					If you selected an option which includes the <em> Dropdown menus</em>
					above, you can choose how they get activated:
					<select name="topmenu_dropdown_trigger">
						<& /comp/options,
							[
								[ "mouseover", "When I move the mouse over the item" ],
								[ "click", "When I click the open submenu icon" ]
							],
							UserPreference::get('topmenu_dropdown_trigger') &>
					</select>
				</div>

			<& /comp/tableend &>

			<& /comp/tablebegin, title => "Use of Javascript" &>

				<div>
					On each page which uses it, the "Guess Case" box should initially be
					<select name="autofix_open">
						<& /comp/options,
							[
								[ "remember", "how I last left it" ],
								[ "1", "open" ],
								[ "0", "closed" ],
							],
							UserPreference::get('autofix_open') &>
					</select>
				</div>
				<div>
					<label for="pref_JSMoveFocus">
					<input type="checkbox" name="JSMoveFocus" id="pref_JSMoveFocus"
%						$m->out(UserPreference::get('JSMoveFocus') ? ' checked="checked" ' : "");
						/>
					Use Javascript to move the input focus when the page loads.</label>
				</div>

				<div>
					<label for="pref_JSDiff">
					<input type="checkbox" name="JSDiff" id="pref_JSDiff"
%						$m->out(UserPreference::get('JSDiff') ? ' checked="checked" ' : "");
						/>
					Use javascript to highlight changes on title edits.</label>
				</div>

				<div>
					<label for="pref_JSCollapse">
					<input type="checkbox" name="JSCollapse" id="pref_JSCollapse"
%						$m->out(UserPreference::get('JSCollapse') ? ' checked="checked" ' : "");
						/>
					Collapse releases per default on pages which show full releases (except the release page)</label>
				</div>

				<div>
					<label for="pref_JSDebug">
					<input type="checkbox" name="JSDebug" id="pref_JSDebug"
%						$m->out(UserPreference::get('JSDebug') ? ' checked="checked" ' : "");
						/>
					Show the Javascript debug box on the bottom of the page.</label>
				</div>

			<& /comp/tableend &>

			<& /comp/tablebegin, title => "Display options" &>

				<b>Sidebar panels:</b>

				<ul style="list-style: none">
					<li>
						<label for="pref_sidebar_panel_sites"><input type="checkbox" name="sidebar_panel_sites"
							id="pref_sidebar_panel_sites"
%							$m->out(UserPreference::get('sidebar_panel_sites') ? ' checked="checked" ' : "");
							/> MusicBrainz sites.</label>
					</li>
					<li>
						<label for="pref_sidebar_panel_user"><input type="checkbox" name="sidebar_panel_user"
							id="pref_sidebar_panel_user"
%							$m->out(UserPreference::get('sidebar_panel_user') ? ' checked="checked" ' : "");
							/> Your account.</label>
					</li>
					<li>
						<label for="pref_sidebar_panel_search"><input type="checkbox" name="sidebar_panel_search"
							id="pref_sidebar_panel_search"
%							$m->out(UserPreference::get('sidebar_panel_search') ? ' checked="checked" ' : "");
							/> Quick search.</label>
					</li>
					<li>
						<label for="pref_sidebar_panel_topmods"><input type="checkbox" name="sidebar_panel_topmods"
							id="pref_sidebar_panel_topmods"
%							$m->out(UserPreference::get('sidebar_panel_topmods') ? ' checked="checked" ' : "");
							/> Top editors.</label>
					</li>
					<li>
						<label for="pref_sidebar_panel_stats"><input type="checkbox" name="sidebar_panel_stats"
							id="pref_sidebar_panel_stats"
%							$m->out(UserPreference::get('sidebar_panel_stats') ? ' checked="checked" ' : "");
							/> Server stats.</label>
					</li>
				</ul>

					<label for="pref_nosidebar"><input type="checkbox" name="nosidebar"
						id="pref_nosidebar"
%						$m->out(UserPreference::get('nosidebar') ? ' checked="checked" ' : "");
						/>
						Do not show the sidebar at all (even faster, but it makes it
						rather hard to navigate the site).</label><br />

					<label for="pref_css_noentityicons"><input type="checkbox" name="css_noentityicons"
						id="pref_css_noentityicons"
%						$m->out(UserPreference::get('css_noentityicons') ? ' checked="checked" ' : "");
						/>
						Do not show icons for links to artists <img src="/images/entity/artist_small.gif" alt="" />,
						releases <img src="/images/entity/release_small.gif" alt="" /> and tracks
						<img src="/images/entity/track_small.gif" alt="" />.</label><br />

					<label for="pref_show_ratings"><input type="checkbox" name="show_ratings"
						id="pref_show_ratings"
%						$m->out(UserPreference::get('show_ratings') ? ' checked="checked" ' : "");
						/>
						Show ratings.</label><br />

					<label for="pref_css_nosmallfonts"><input type="checkbox" name="css_nosmallfonts"
						id="pref_css_nosmallfonts"
%						$m->out(UserPreference::get('css_nosmallfonts') ? ' checked="checked" ' : "");
						/>
						Do not use fonts smaller than 12px.</label><br />




			<& /comp/tableend &>

			<& /comp/tablebegin, title => "Privacy settings" &>

				<div>
					<label for="pref_subscriptions_public"><input type="checkbox" name="subscriptions_public" id="pref_subscriptions_public"
%						$m->out(UserPreference::get('subscriptions_public') ? ' checked="checked" ' : "");
						/>
					Allow other users to see <a href="/user/subscriptions.html"
						>my subscriptions</a>.</label>
					(see <& /comp/linkdoc, "MusicBrainzPrivacyPolicy", "notes", 0, 0 &>)
				</div>
				<div>
					<label for="pref_tags_public"><input type="checkbox" name="tags_public" id="pref_tags_public"
%						$m->out(UserPreference::get('tags_public') ? ' checked="checked" ' : "");
						/>
					Allow other users to see my <& /comp/linkdoc, "FolksonomyTagging", "folksonomy tags", 0, 0 &>.</label>
				</div>
				<div>
					<label for="pref_ratings_public"><input type="checkbox" name="ratings_public" id="pref_ratings_public"
%						$m->out(UserPreference::get('ratings_public') ? ' checked="checked" ' : "");
						/>
					Allow other users to see my <& /comp/linkdoc, "RatingSystem", "ratings", 0, 0 &>.</label>
				</div>

			<& /comp/tableend &>


% 	if (UserStuff->IsAutoEditor($session{orig_privs}))
%	{

			<& /comp/tablebegin, title => "Temporary preferences" &>

				<div>
					These preferences are not saved permanently; they are reset every time
					you log in.
				</div>

				<div>
					<label for="pref_enable_automod_privs">
					<input type="checkbox" name="enable_automod_privs" id="pref_enable_automod_privs"
%						$m->out(UserStuff->IsAutoEditor($session{privs}) ? ' checked="checked" ' : "");
						/>
					Enable AutoEditor privileges.</label>
				</div>


			<& /comp/tableend &>
% 	}


			<div>
				<input type="submit" value="Update &raquo;" />
			</div>
		</div>
	</form>
	<script type="text/javascript">
		var f=document.forms.PreferencesForm;
		f.mod_add_album_link.disabled = !(f.mod_add_album_inline.checked);
	</script>
	<& /comp/movefocus, "PreferencesForm", "mod_add_album_inline" &>

<& /comp/footer &>

%# vi: set ts=4 sw=4 ft=mason :
