<%perl>
	# -----------------------------------------------------------------------------
	#                               Musicbrainz.org
	#                        Copyright (c) 2001 Robert Kaye
	# -----------------------------------------------------------------------------
	#  This software is provided "as is", without warranty of any kind, express or
	#  implied, including  but not limited  to the warranties of  merchantability,
	#  fitness for a particular purpose and noninfringement. In no event shall the
	#  authors or  copyright  holders be  liable for any claim,  damages or  other
	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
	#  from,  out of  or in  connection with  the software or  the  use  or  other
	#  dealings in the software.
	#
	#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
	#  Permits anyone the right to use and modify the software without limitations
	#  as long as proper  credits are given  and the original  and modified source
	#  code are included. Requires  that the final product, software derivate from
	#  the original  source or any  software  utilizing a GPL  component, such  as
	#  this, is also licensed under the GPL license.
	# -----------------------------------------------------------------------------
	#
	# Summary:
	# -----------------------------------------------------------------------------
	# This page provides the old (direct to database) search functionality.
	#
	# $Id$
	#
</%perl>
<%args>

	$handlearguments => 0

</%args>
<%perl>

	# catch queries which have been created before the session handling and trigger
	# storing of these values.
	if ($ARGS{"search"} and
		$ARGS{"table"} and
		not $ARGS{"handlearguments"} and
		not $ARGS{"submitvalue"})
	{
		($handlearguments, $ARGS{"handlearguments"}) = (1,1);
		$ARGS{"type"} = ($ARGS{"table"} eq "album" ? "release" : $ARGS{"table"});
		$ARGS{"query"} = $ARGS{"search"};
	}

	$m->comp("/search/handle-searchsession.inc", %ARGS)
		if ($handlearguments);

	# Initialise MusicBrainz object
	my $mb = $m->comp("/comp/dblogin");
	use SearchEngine qw( :constants );

	# Initialise Engine, then carry out the search.
	my $engine;

	if ($session{"as_type"} =~ /\A(artist|label|release|track)\z/)
	{
		$engine = SearchEngine->new($mb->{DBH}, $session{"as_type"} eq "release" ? "album" : $session{"as_type"});
		$engine->Search(
			query => $session{"as_query"},
			limit => $session{"as_limit"},
		);

		if ($engine->Rows == 1)
		{
			my ($row, $url);
			$row = $engine->NextRow;
			if ($session{"as_type"} eq "release")
			{
				$url = "/show/release/?releaseid=$row->{'albumid'}";
			}
			elsif ($session{"as_type"} eq "artist")
			{
				$url = "/show/artist/?artistid=$row->{'artistid'}";
			}
			elsif ($session{"as_type"} eq "track")
			{
				$url = "/show/track/?trackid=$row->{'trackid'}";
			}
			elsif ($session{"as_type"} eq "label")
			{
				$url = "/show/label/?labelid=$row->{'labelid'}";
			}
			if (defined $url)
			{
				$r->method('GET');
				$r->headers_in->unset('Content-length');
				$r->content_type('text/html');
				$r->header_out(Location => $url);
				$r->status(302);
				$mb->Logout();
				return undef;
			}
		}
	}

</%perl>

<& /comp/sidebar-notitle, pagetitle => ucfirst($session{"as_type"}) . ' Search Results: '.$session{"as_query"} &>

%	if ($session{"as_query"} ne "")
%	{

%		if (!$engine)
%		{

		<& /comp/tablebegin, title => "Unsupported search type" &>
			Sorry, that search type is not supported as a direct search.
		<& /comp/tableend &>

%		}
%		elsif ($engine->Result == SEARCHRESULT_NOQUERY)
%		{

		<& /comp/tablebegin, title => "Nothing to search for!" &>
			Please enter a search phrase including
			letters and/or numbers.
		<& /comp/tableend &>

%		}
%		elsif ($engine->Result == SEARCHRESULT_TIMEOUT)
%		{

		<& /comp/tablebegin, title => "Your search has been cancelled." &>
			Your search has been cancelled because it was taking too
			long. Please try changing your search criteria - try using
			just the most distinctive words and leaving out the
			more common ones. Or just try again later.
		<& /comp/tableend &>

%		}
%		elsif ($engine->Rows == 0)
%		{

		<& /comp/tablebegin, title => "No ".$session{"as_type"}."s found matching your query" &>

%			if ($session{"as_type"} eq "label")
%			{
				Please consider <a href="/edit/label/add.html?initial_name=<% uri_escape($session{"as_query"}) %>">adding a new label</a>.
%			}
%			else
%			{
				Please consider <a href="/freedb/freedb.html?search=<% uri_escape($session{"as_query"}) %>"
				>importing</a> the artist/release/track(s) you are looking for from freedb.

%				if ($session{"as_type"} eq "artist")
%				{
					Alternatively, <a href="/edit/artist/add.html?initial_name=<% uri_escape($session{"as_query"}) %>">add a new artist</a>.
%				}
%				elsif ($session{"as_type"} eq "release")
%				{
					Alternatively, <a href="/edit/album/add.html?artistid=0">add a new release</a>.
%				}
%			}

		<& /comp/tableend &>

%		}
%		else
%		{

		<& /comp/layout/editformbegin, title => "The following ".$session{"as_type"}."s matched your query", mp => 1, show_coc => 0 &>

			<table class="searchresults">

%			if ($session{"as_type"} eq "release")
%			{
				<tr class="searchresultsheader">
					<td>Artist:</td>
					<td>Release Title:</td>
					<td class="tracks">Tracks:</td>
					<td class="discid">Disc IDs:</td>
					<td class="puid">PUIDs:</td>
					<td class="released">Released:</td>

				</tr>
				<tr class="searchresultssmall">
					<td colspan="2"></td>
				</tr>
%			}
%			elsif ($session{"as_type"} eq "artist")
%			{

				<tr class="searchresultsheader">
					<td>Artist:</td>
				</tr>
%			}
%			elsif ($session{"as_type"} eq "label")
%			{

				<tr class="searchresultsheader">
					<td>Label:</td>
				</tr>
%			}
%			elsif ($session{"as_type"} eq "track")
%			{
				<tr class="searchresultsheader">
					<td>Artist:</td>
					<td>Release:</th>
					<td>Track Title:</td>
					<td class="num">Num:</td>
					<td class="length">Length:</td>
				</tr>
%			}

%  			my $i = 0;
%   		while ( my $row = $engine->NextRow )
%			{
        		<tr class="<% $i++ % 2 == 0 ? "searchresultseven" : "searchresultsodd" %>">

%   		    if ($session{"as_type"} eq "release")
%				{
					<td>
						<span<% $row->{'artistmp'} ? ' class="mp"' : '' |n %>>
							<& /comp/linkartist, id => $row->{'artistid'}, name => $row->{'artistname'}, resolution => $row->{artistresolution}, strong => 0 &>
						</span></td>

					<td>
						<span<% $row->{'releasemp'} ? ' class="mp"' : '' |n %>>
							<& /comp/linkrelease, id => $row->{'albumid'}, name => $row->{'albumname'}, strong => 0 &>
						</span></td>

% 					if ($row->{tracks})
%					{
					<td class="tracks"><% $row->{tracks} %> <img src="/images/notes.gif" alt="Tracks" /></td>
%					}
%					else
%					{
					<td class="tracks">&nbsp;</td>
% 					}
% 					if ($row->{discids})
%					{
					<td class="discid"><% $row->{discids} %> <img src="/images/cd.gif" alt="Disc IDs" /></td>
%					}
%					else
%					{
					<td class="discid">&nbsp;</td>
% 					}
%					if ($row->{puids})
%					{
					<td class="puid"><% $row->{puids} %> <img src="/images/puid.gif" alt="PUIDs" /></td>
%					}
%					else
%					{
					<td class="puid">&nbsp;</td>
% 					}
%					if ($row->{firstreleasedate})
%					{
					<td class="released"><& /comp/releasedate, $row->{firstreleasedate} &></td>
% 					}
%					else
%					{
					<td class="released">&nbsp;</td>
% 					}

%				}
%				elsif ($session{"as_type"} eq "artist")
%				{

            		<td>
            			<span<% $row->{'artistmp'} ? ' class="mp"' : '' |n %>>
            				<& /comp/linkartist, id => $row->{'artistid'}, name => $row->{'artistname'}, resolution => $row->{artistresolution}, strong => 0 &>
            			</span></td>


%				}
%				elsif ($session{"as_type"} eq "label")
%				{

            		<td>
            			<span<% $row->{'labelmp'} ? ' class="mp"' : '' |n %>>
            				<& /comp/linklabel, id => $row->{'labelid'}, name => $row->{'labelname'}, resolution => $row->{labelresolution}, strong => 0 &>
            			</span></td>


%				}
%				elsif ($session{"as_type"} eq "track")
%				{

					<td>
						<span<% $row->{'artistmp'} ? ' class="mp"' : '' |n %>>
							<& /comp/linkartist, id => $row->{'artistid'}, name => $row->{'artistname'}, resolution => $row->{artistresolution}, strong => 0 &>
						</span></td>
					<td>
						<span<% $row->{'releasemp'} ? ' class="mp"' : '' |n %>>
							<& /comp/linkrelease, id => $row->{'albumid'}, name => $row->{'albumname'}, strong => 0 &>
						</span></td>
					<td>
						<span<% $row->{'trackmp'} ? ' class="mp"' : '' |n %>>
							<& /comp/linktrack, id => $row->{'trackid'}, name => $row->{'trackname'}, strong => 0 &>
						</span></td>
					<td class="num">
						<span<% $row->{'albumjoinmp'} ? ' class="mp"' : '' |n %>>
							<% $row->{'trackseq'} %>
						</span></td>
					<td class="length">
						<% MusicBrainz::Server::Track::FormatTrackLength($row->{'tracklength'}) %></td>

%   		    }

				</tr>
%			}

			</table>

		<& /comp/tableend &>

% 		}
% 	}


	<& /comp/tablebegin, title => "Search (Direct Search)" &>

    	<& /comp/textsearch, handlearguments => 0 &>

  	<& /comp/tableend &>

	<& /comp/movefocus, id => "id_search" &>

<& /comp/footer &>

%# vi: set ts=4 sw=4 ft=mason :
