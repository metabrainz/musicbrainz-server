-- Generated by CompileSchemaScripts.pl from:
-- 20241017-mbs-9253-master_and_standalone.sql
-- 20250425-mbs-13464-master_and_standalone.sql
-- 20250320-mbs-13768-fks.sql
\set ON_ERROR_STOP 1
BEGIN;
SET search_path = musicbrainz, public;
SET LOCAL statement_timeout = 0;
--------------------------------------------------------------------------------
SELECT '20241017-mbs-9253-master_and_standalone.sql';

SET search_path = musicbrainz;


ALTER TABLE artist_release_group
   ADD CONSTRAINT artist_release_group_fk_artist
   FOREIGN KEY (artist)
   REFERENCES artist(id)
   ON DELETE CASCADE;

ALTER TABLE artist_release_group
   ADD CONSTRAINT artist_release_group_fk_release_group
   FOREIGN KEY (release_group)
   REFERENCES release_group(id)
   ON DELETE CASCADE;

CREATE TRIGGER a_upd_release_group_primary_type AFTER UPDATE ON release_group_primary_type
    FOR EACH ROW EXECUTE PROCEDURE a_upd_release_group_primary_type_mirror();

CREATE TRIGGER a_upd_release_group_secondary_type AFTER UPDATE ON release_group_secondary_type
    FOR EACH ROW EXECUTE PROCEDURE a_upd_release_group_secondary_type_mirror();

CREATE CONSTRAINT TRIGGER apply_artist_release_group_pending_updates
    AFTER UPDATE ON release_group_primary_type DEFERRABLE INITIALLY DEFERRED
    FOR EACH ROW
    WHEN (OLD.child_order IS DISTINCT FROM NEW.child_order)
    EXECUTE PROCEDURE apply_artist_release_group_pending_updates();

CREATE CONSTRAINT TRIGGER apply_artist_release_group_pending_updates
    AFTER UPDATE ON release_group_secondary_type DEFERRABLE INITIALLY DEFERRED
    FOR EACH ROW
    WHEN (OLD.child_order IS DISTINCT FROM NEW.child_order)
    EXECUTE PROCEDURE apply_artist_release_group_pending_updates();

--------------------------------------------------------------------------------
SELECT '20250425-mbs-13464-master_and_standalone.sql';

SET search_path = musicbrainz;


ALTER TABLE artist_release
   ADD CONSTRAINT artist_release_fk_artist
   FOREIGN KEY (artist)
   REFERENCES artist(id)
   ON DELETE CASCADE;

ALTER TABLE artist_release
   ADD CONSTRAINT artist_release_fk_release
   FOREIGN KEY (release)
   REFERENCES release(id)
   ON DELETE CASCADE;

--------------------------------------------------------------------------------
SELECT '20250320-mbs-13768-fks.sql';

SET search_path = musicbrainz;


ALTER TABLE medium_gid_redirect
   ADD CONSTRAINT medium_gid_redirect_fk_new_id
   FOREIGN KEY (new_id)
   REFERENCES medium(id);

COMMIT;
